<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.36" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://xlc520.github.io/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html"><meta property="og:site_name" content="StudyNote"><meta property="og:title" content="SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯"><meta property="og:description" content="SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="xlc520"><meta property="article:tag" content="Java"><meta property="article:published_time" content="2022-02-13T00:00:00.000Z"><link rel="stylesheet" href="//at.alicdn.com/t/font_2410206_mfj6e1vbwo.css"><title>SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯ | StudyNote</title><meta name="description" content="SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.294ae36c.css">
    <link rel="modulepreload" href="/assets/app.1ee1cb07.js"><link rel="modulepreload" href="/assets/SpringBoot_SpringSecurityå‰åç«¯åˆ†ç¦»_Jwtçš„æƒé™è®¤è¯.html.d2ece3bf.js"><link rel="modulepreload" href="/assets/SpringBoot_SpringSecurityå‰åç«¯åˆ†ç¦»_Jwtçš„æƒé™è®¤è¯.html.17632fb7.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.svg" alt="StudyNote"><!----><span class="site-name hide-in-pad">StudyNote</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" arialabel="Home"><i class="icon iconfont icon-home"></i>Home<!----></a></div><div class="nav-item hide-in-mobile"><a href="/study/" class="nav-link" arialabel="å­¦ä¹ "><i class="icon iconfont icon-note"></i>å­¦ä¹ <!----></a></div><div class="nav-item hide-in-mobile"><a href="/java/" class="nav-link active" arialabel="Java"><i class="icon iconfont icon-java"></i>Java<!----></a></div><div class="nav-item hide-in-mobile"><a href="/linux/" class="nav-link" arialabel="Linux"><i class="icon iconfont icon-linux"></i>Linux<!----></a></div><div class="nav-item hide-in-mobile"><a href="/script/" class="nav-link" arialabel="è„šæœ¬"><i class="icon iconfont icon-script"></i>è„šæœ¬<!----></a></div><div class="nav-item hide-in-mobile"><a href="/tools/" class="nav-link" arialabel="å·¥å…·"><i class="icon iconfont icon-tool"></i>å·¥å…·<!----></a></div><div class="nav-item hide-in-mobile"><a href="/source_code/" class="nav-link" arialabel="æºç "><i class="icon iconfont icon-code"></i>æºç <!----></a></div><div class="nav-item hide-in-mobile"><a href="/git/" class="nav-link" arialabel="Git"><i class="icon iconfont icon-git"></i>Git<!----></a></div><div class="nav-item hide-in-mobile"><a href="/daily/" class="nav-link" arialabel="æ—¥å¸¸"><i class="icon iconfont icon-date"></i>æ—¥å¸¸<!----></a></div><div class="nav-item hide-in-mobile"><a href="/other/" class="nav-link" arialabel="å…¶ä»–"><i class="icon iconfont icon-others"></i>å…¶ä»–<!----></a></div><div class="nav-item hide-in-mobile"><a href="https://git.xulc.workers.dev/" rel="noopener noreferrer" target="_blank" arialabel="DownGit" class="nav-link"><i class="icon iconfont icon-github"></i>DownGit<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/xlc520/xlc520.github.io" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" arialabelledby="outlook"><title id="outlook" lang="en">outlook icon</title><g fill="currentColor"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></g></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/java/" class="nav-link sidebar-link sidebar-page" arialabel="Java"><!---->Java<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/idea-tips.html" class="nav-link sidebar-link sidebar-page" arialabel="Intellij ideaé«˜æ•ˆä½¿ç”¨æ•™ç¨‹"><i class="icon iconfont icon-page"></i>Intellij ideaé«˜æ•ˆä½¿ç”¨æ•™ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/JApiDocs%E6%95%99%E7%A8%8B.html" class="nav-link sidebar-link sidebar-page" arialabel="JApiDocsæ•™ç¨‹"><!---->JApiDocsæ•™ç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/SpringBoot%E9%A1%B9%E7%9B%AE%E9%89%B4%E6%9D%83%E7%9A%84%204%20%E7%A7%8D%E6%96%B9%E5%BC%8F.html" class="nav-link sidebar-link sidebar-page" arialabel="Spring Boot é¡¹ç›®é‰´æƒçš„ 4 ç§æ–¹å¼"><!---->Spring Boot é¡¹ç›®é‰´æƒçš„ 4 ç§æ–¹å¼<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/SpringBoot%E5%90%AF%E5%8A%A8banner.html" class="nav-link sidebar-link sidebar-page" arialabel="Spring Bootå¯åŠ¨çš„æ—¶å€™é»˜è®¤çš„banner"><!---->Spring Bootå¯åŠ¨çš„æ—¶å€™é»˜è®¤çš„banner<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/SpringCloudAlibaba.html" class="nav-link sidebar-link sidebar-page" arialabel="Spring Cloud Alibaba"><!---->Spring Cloud Alibaba<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/Spring%20%E9%9D%A2%E8%AF%9563%E9%97%AE.html" class="nav-link sidebar-link sidebar-page" arialabel="Spring é¢è¯•63é—®"><!---->Spring é¢è¯•63é—®<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/SpringBoot%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8A%A8%E6%80%81%E7%AE%A1%E7%90%86%E9%80%9A%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html" class="nav-link sidebar-link sidebar-page" arialabel="SpringBoot å®šæ—¶ä»»åŠ¡åŠ¨æ€ç®¡ç†é€šç”¨è§£å†³æ–¹æ¡ˆ"><!---->SpringBoot å®šæ—¶ä»»åŠ¡åŠ¨æ€ç®¡ç†é€šç”¨è§£å†³æ–¹æ¡ˆ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯"><!---->SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#å‰è¨€" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="å‰è¨€"><!---->å‰è¨€<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªuser" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªUser"><!---->ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªUser<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-1-authenticationentrypoint" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.1 AuthenticationEntryPoint"><!---->1.1 AuthenticationEntryPoint<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-2-authenticationsuccesshandler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.2 AuthenticationSuccessHandler"><!---->1.2 AuthenticationSuccessHandler<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-3-authenticationfailurehandler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3 AuthenticationFailureHandler"><!---->1.3 AuthenticationFailureHandler<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-4-logoutsuccesshandler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.4 LogoutSuccessHandler"><!---->1.4 LogoutSuccessHandler<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-5-accessdeniedhandler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.5 AccessDeniedHandler"><!---->1.5 AccessDeniedHandler<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-6-ä¸€ä¸ªè¿‡æ»¤å™¨onceperrequestfilter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.6 ä¸€ä¸ªè¿‡æ»¤å™¨OncePerRequestFilter"><!---->1.6 ä¸€ä¸ªè¿‡æ»¤å™¨OncePerRequestFilter<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-7-å®ç°userdetailsæ‰©å……å­—æ®µ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.7 å®ç°UserDetailsæ‰©å……å­—æ®µ"><!---->1.7 å®ç°UserDetailsæ‰©å……å­—æ®µ<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-8-å®ç°userdetailsservice" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.8 å®ç°UserDetailsService"><!---->1.8 å®ç°UserDetailsService<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-9-usersessionservice" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.9 userSessionService"><!---->1.9 userSessionService<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-10-resonseutil" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.10 ResonseUtil"><!---->1.10 ResonseUtil<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#äºŒã€é…ç½®websecurityconfigureradapter" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="äºŒã€é…ç½®WebSecurityConfigurerAdapter"><!---->äºŒã€é…ç½®WebSecurityConfigurerAdapter<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#ä¸‰ã€å…¶ä»–" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="ä¸‰ã€å…¶ä»–"><!---->ä¸‰ã€å…¶ä»–<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_3-1-ä¸è¶³ä¹‹å¤„" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.1 ä¸è¶³ä¹‹å¤„"><!---->3.1 ä¸è¶³ä¹‹å¤„<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_3-2-è§£å†³" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2 è§£å†³"><!---->3.2 è§£å†³<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/java/%E5%B0%86Bean%E6%94%BE%E5%85%A5Spring%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%847%E7%A7%8D%E6%96%B9%E5%BC%8F.html" class="nav-link sidebar-link sidebar-page" arialabel="SpringBootå°†Beanæ”¾å…¥Springå®¹å™¨ä¸­çš„äº”ç§æ–¹å¼"><!---->SpringBootå°†Beanæ”¾å…¥Springå®¹å™¨ä¸­çš„äº”ç§æ–¹å¼<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/%E4%BD%BF%E7%94%A8docker%E5%BF%AB%E9%80%9F%E5%AE%89%E8%A3%85oracle.html" class="nav-link sidebar-link sidebar-page" arialabel="ä½¿ç”¨dockerå¿«é€Ÿå®‰è£…oracle"><!---->ä½¿ç”¨dockerå¿«é€Ÿå®‰è£…oracle<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/%E6%8A%A5%E9%94%99%E5%BC%82%E5%B8%B8%E8%A7%A3%E5%86%B3.html" class="nav-link sidebar-link sidebar-page" arialabel="å¼€å‘ä¸­æŠ¥é”™å¼‚å¸¸è§£å†³"><!---->å¼€å‘ä¸­æŠ¥é”™å¼‚å¸¸è§£å†³<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8BJava%E7%B1%BB%E5%9E%8B.html" class="nav-link sidebar-link sidebar-page" arialabel="æ•°æ®ç±»å‹Javaç±»å‹"><!---->æ•°æ®ç±»å‹Javaç±»å‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/java/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%90%8E%E7%AB%AF%E6%80%BB%E7%BB%93%E7%9A%84%E9%9D%A2%E8%AF%9515%E9%97%AE.html" class="nav-link sidebar-link sidebar-page" arialabel="è…¾è®¯äº‘åç«¯æ€»ç»“çš„é¢è¯•15é—®"><!---->è…¾è®¯äº‘åç«¯æ€»ç»“çš„é¢è¯•15é—®<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯</h1><div class="article-info"><span class="author-info" arialabel="ä½œè€…ğŸ–Š" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><span class="author-item">xlc520</span></span><span property="author" content="xlc520"></span></span><!----><span class="date-info" arialabel="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022å¹´2æœˆ13æ—¥</span><meta property="datePublished" content="2022-02-13T00:00:00.000Z"></span><span class="category-info" arialabel="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category category4 clickable" role="navigation">Java</li><meta property="articleSection" content="Java"></ul></span><span arialabel="æ ‡ç­¾ğŸ·" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag tag4 clickable" role="navigation">Java</li></ul><meta property="keywords" content="Java"></span><span class="reading-time-info" arialabel="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" arialabelledby="timer"><title id="timer" lang="en">timer icon</title><g fill="currentColor"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></g></svg><span>å¤§çº¦ 15 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT15M"></span><span class="words-info" arialabel="å­—æ•°ğŸ” " data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" arialabelledby="word"><title id="word" lang="en">word icon</title><g fill="currentColor"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></g></svg><span>çº¦ 4476 å­—</span><meta property="wordCount" content="4476"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#å‰è¨€" class="router-link-active router-link-exact-active toc-link level2">å‰è¨€</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªuser" class="router-link-active router-link-exact-active toc-link level2">ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªUser</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-1-authenticationentrypoint" class="router-link-active router-link-exact-active toc-link level3">1.1 AuthenticationEntryPoint</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-2-authenticationsuccesshandler" class="router-link-active router-link-exact-active toc-link level3">1.2 AuthenticationSuccessHandler</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-3-authenticationfailurehandler" class="router-link-active router-link-exact-active toc-link level3">1.3 AuthenticationFailureHandler</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-4-logoutsuccesshandler" class="router-link-active router-link-exact-active toc-link level3">1.4 LogoutSuccessHandler</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-5-accessdeniedhandler" class="router-link-active router-link-exact-active toc-link level3">1.5 AccessDeniedHandler</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-6-ä¸€ä¸ªè¿‡æ»¤å™¨onceperrequestfilter" class="router-link-active router-link-exact-active toc-link level3">1.6 ä¸€ä¸ªè¿‡æ»¤å™¨OncePerRequestFilter</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-7-å®ç°userdetailsæ‰©å……å­—æ®µ" class="router-link-active router-link-exact-active toc-link level3">1.7 å®ç°UserDetailsæ‰©å……å­—æ®µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-8-å®ç°userdetailsservice" class="router-link-active router-link-exact-active toc-link level3">1.8 å®ç°UserDetailsService</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-9-usersessionservice" class="router-link-active router-link-exact-active toc-link level3">1.9 userSessionService</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_1-10-resonseutil" class="router-link-active router-link-exact-active toc-link level3">1.10 ResonseUtil</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#äºŒã€é…ç½®websecurityconfigureradapter" class="router-link-active router-link-exact-active toc-link level2">äºŒã€é…ç½®WebSecurityConfigurerAdapter</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#ä¸‰ã€å…¶ä»–" class="router-link-active router-link-exact-active toc-link level2">ä¸‰ã€å…¶ä»–</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_3-1-ä¸è¶³ä¹‹å¤„" class="router-link-active router-link-exact-active toc-link level3">3.1 ä¸è¶³ä¹‹å¤„</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/java/SpringBoot+SpringSecurity%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB+Jwt%E7%9A%84%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81.html#_3-2-è§£å†³" class="router-link-active router-link-exact-active toc-link level3">3.2 è§£å†³</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><h1 id="springboot-springsecurityå‰åç«¯åˆ†ç¦»-jwtçš„æƒé™è®¤è¯" tabindex="-1"><a class="header-anchor" href="#springboot-springsecurityå‰åç«¯åˆ†ç¦»-jwtçš„æƒé™è®¤è¯" aria-hidden="true">#</a> SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯</h1><h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ç”¨SpringSecurityé»˜è®¤çš„è¯æ˜¯å‰åç«¯æ•´åœ¨ä¸€èµ·çš„ï¼Œæ¯”å¦‚<a href="https://so.csdn.net/so/search?q=thymeleaf&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">thymeleaf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æˆ–è€…Freemarkerï¼ŒSpringSecurityè¿˜è‡ªå¸¦loginç™»å½•é¡µ,è¿˜è®©ä½ é…ç½®ç™»å‡ºé¡µ,é”™è¯¯é¡µã€‚ ä½†æ˜¯ç°åœ¨å‰åç«¯åˆ†ç¦»æ‰æ˜¯æ­£é“ï¼Œå‰åç«¯åˆ†ç¦»çš„è¯ï¼Œé‚£å°±éœ€è¦å°†è¿”å›çš„é¡µé¢æ¢æˆJsonæ ¼å¼äº¤ç»™å‰ç«¯å¤„ç†äº†</p><p>SpringSecurityé»˜è®¤çš„æ˜¯é‡‡ç”¨<a href="https://so.csdn.net/so/search?q=Session&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">Session<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>æ¥åˆ¤æ–­è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦ç™»å½•çš„ï¼Œä½†æ˜¯ä¸æ–¹ä¾¿åˆ†å¸ƒå¼çš„æ‰©å±•ï¼Œè™½ç„¶SpringSecurityä¹Ÿæ”¯æŒé‡‡ç”¨SpringSessionæ¥ç®¡ç†åˆ†å¸ƒå¼ä¸‹çš„ç”¨æˆ·çŠ¶æ€ï¼Œä¸è¿‡ç°åœ¨åˆ†å¸ƒå¼çš„è¿˜æ˜¯æ— çŠ¶æ€çš„Jwtæ¯”è¾ƒä¸»æµã€‚ æ‰€ä»¥ä¸‹é¢è¯´ä¸‹æ€ä¹ˆè®©SpringSecurityå˜æˆå‰åç«¯åˆ†ç¦»ï¼Œé‡‡ç”¨Jwtæ¥åšè®¤è¯çš„</p><h2 id="ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªuser" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªuser" aria-hidden="true">#</a> ä¸€ã€äº”ä¸ªhandlerä¸€ä¸ªfilterä¸¤ä¸ªUser</h2><p>5ä¸ªhandlerï¼Œåˆ†åˆ«æ˜¯</p><ul><li>å®ç°AuthenticationEntryPointæ¥å£,å½“åŒ¿åè¯·æ±‚éœ€è¦ç™»å½•çš„æ¥å£æ—¶,æ‹¦æˆªå¤„ç†</li><li>å®ç°AuthenticationSuccessHandleræ¥å£,å½“ç™»å½•æˆåŠŸå,è¯¥å¤„ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨</li><li>å®ç°AuthenticationFailureHandleræ¥å£,å½“ç™»å½•å¤±è´¥å,è¯¥å¤„ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨</li><li>å®ç°AccessDeniedHandleræ¥å£,å½“ç™»å½•å,è®¿é—®æ¥å£æ²¡æœ‰æƒé™çš„æ—¶å€™,è¯¥å¤„ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨</li><li>å®ç°LogoutSuccessHandleræ¥å£,æ³¨é”€çš„æ—¶å€™è°ƒç”¨</li></ul><h3 id="_1-1-authenticationentrypoint" tabindex="-1"><a class="header-anchor" href="#_1-1-authenticationentrypoint" aria-hidden="true">#</a> 1.1 AuthenticationEntryPoint</h3><p>åŒ¿åæœªç™»å½•çš„æ—¶å€™è®¿é—®ï¼Œé‡åˆ°éœ€è¦ç™»å½•è®¤è¯çš„æ—¶å€™è¢«è°ƒç”¨</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * åŒ¿åæœªç™»å½•çš„æ—¶å€™è®¿é—®,éœ€è¦ç™»å½•çš„èµ„æºçš„è°ƒç”¨ç±»
 * <span class="token keyword">@author</span> zzzgd
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerAuthenticationEntryPoint</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
	    <span class="token comment">//è®¾ç½®responseçŠ¶æ€ç ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ç­‰</span>
	    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeConstants</span><span class="token punctuation">.</span>REQUIRED_LOGIN_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">1234567891011121314</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_1-2-authenticationsuccesshandler" tabindex="-1"><a class="header-anchor" href="#_1-2-authenticationsuccesshandler" aria-hidden="true">#</a> 1.2 AuthenticationSuccessHandler</h3><p>è¿™é‡Œæ˜¯æˆ‘ä»¬è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•æˆåŠŸåï¼Œè°ƒç”¨çš„æ–¹æ³• ç®€å•çš„è¯´å°±æ˜¯è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨JWTç”Ÿæˆtokenï¼Œç„¶åè¿”å›token</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç™»å½•æˆåŠŸå¤„ç†ç±»,ç™»å½•æˆåŠŸåä¼šè°ƒç”¨é‡Œé¢çš„æ–¹æ³•
 * <span class="token keyword">@author</span> Exrickx
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerAuthenticationSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationSuccessHandler</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    	<span class="token comment">//ç®€å•çš„è¯´å°±æ˜¯è·å–å½“å‰ç”¨æˆ·ï¼Œæ‹¿åˆ°ç”¨æˆ·åæˆ–è€…userIdï¼Œåˆ›å»ºtokenï¼Œè¿”å›</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç™»é™†æˆåŠŸ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CustomerUserDetails</span> principal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CustomerUserDetails</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//é¢å‘token</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> emptyMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        emptyMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">UserConstants</span><span class="token punctuation">.</span>USER_ID<span class="token punctuation">,</span>principal<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtTokenUtil</span><span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>principal<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> emptyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">12345678910111213141516171819202122</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_1-3-authenticationfailurehandler" tabindex="-1"><a class="header-anchor" href="#_1-3-authenticationfailurehandler" aria-hidden="true">#</a> 1.3 AuthenticationFailureHandler</h3><p>æœ‰ç™»é™†æˆåŠŸå°±æœ‰ç™»å½•å¤±è´¥ ç™»å½•å¤±è´¥çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åœ¨å…¶ä¸­åšç™»å½•é”™è¯¯é™åˆ¶æˆ–è€…å…¶ä»–æ“ä½œï¼Œæˆ‘è¿™é‡Œç›´æ¥å°±æ˜¯è®¾ç½®å“åº”å¤´çš„çŠ¶æ€ç ä¸º401ï¼Œè¿”å›</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç™»å½•è´¦å·å¯†ç é”™è¯¯ç­‰æƒ…å†µä¸‹,ä¼šè°ƒç”¨çš„å¤„ç†ç±»
 * <span class="token keyword">@author</span> Exrickx
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerAuthenticationFailHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
    <span class="token comment">//è®¾ç½®responseçŠ¶æ€ç ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ç­‰</span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeConstants</span><span class="token punctuation">.</span>LOGIN_UNMATCH_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token number">12345678910111213141516171819</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_1-4-logoutsuccesshandler" tabindex="-1"><a class="header-anchor" href="#_1-4-logoutsuccesshandler" aria-hidden="true">#</a> 1.4 LogoutSuccessHandler</h3><p>ç™»å‡ºæ³¨é”€çš„æ—¶å€™è°ƒç”¨ï¼ŒJwtæœ‰ä¸ªç¼ºç‚¹å°±æ˜¯æ— æ³•ä¸»åŠ¨æ§åˆ¶å¤±æ•ˆï¼Œå¯ä»¥é‡‡ç”¨Jwt+sessionçš„æ–¹å¼ï¼Œæ¯”å¦‚åˆ é™¤å­˜å‚¨åœ¨Redisçš„token</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœå°†SpringSecurityçš„sessioné…ç½®ä¸ºæ— çŠ¶æ€ï¼Œæˆ–è€…ä¸ä¿å­˜sessionï¼Œè¿™é‡Œauthenticationä¸ºnullï¼ï¼ ï¼Œæ³¨æ„ç©ºæŒ‡é’ˆé—®é¢˜ã€‚ï¼ˆè¯¦æƒ…è§ä¸‹é¢çš„é…ç½®WebSecurityConfigurerAdapterï¼‰</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ç™»å‡ºæˆåŠŸçš„è°ƒç”¨ç±»
 * <span class="token keyword">@author</span> zzzgd
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerLogoutSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">&quot;Logout Success!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">1234567891011</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_1-5-accessdeniedhandler" tabindex="-1"><a class="header-anchor" href="#_1-5-accessdeniedhandler" aria-hidden="true">#</a> 1.5 AccessDeniedHandler</h3><p>ç™»å½•åï¼Œè®¿é—®ç¼ºå¤±æƒé™çš„èµ„æºä¼šè°ƒç”¨ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * æ²¡æœ‰æƒé™,è¢«æ‹’ç»è®¿é—®æ—¶çš„è°ƒç”¨ç±»
 * <span class="token keyword">@author</span> Exrickx
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerRestAccessDeniedHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDeniedHandler</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeConstants</span><span class="token punctuation">.</span>PERMISSION_DENY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token number">1234567891011121314</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_1-6-ä¸€ä¸ªè¿‡æ»¤å™¨onceperrequestfilter" tabindex="-1"><a class="header-anchor" href="#_1-6-ä¸€ä¸ªè¿‡æ»¤å™¨onceperrequestfilter" aria-hidden="true">#</a> 1.6 ä¸€ä¸ªè¿‡æ»¤å™¨OncePerRequestFilter</h3><p>è¿™é‡Œç®—æ˜¯ä¸€ä¸ªå°é‡ç‚¹ã€‚ ä¸Šé¢æˆ‘ä»¬åœ¨ç™»å½•æˆåŠŸåï¼Œè¿”å›äº†ä¸€ä¸ªtokenï¼Œé‚£æ€ä¹ˆä½¿ç”¨è¿™ä¸ªtokenå‘¢ï¼Ÿ</p><p>å‰ç«¯å‘èµ·è¯·æ±‚çš„æ—¶å€™å°†tokenæ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼Œåœ¨è¿‡æ»¤å™¨ä¸­å¯¹è¯·æ±‚å¤´è¿›è¡Œè§£æã€‚</p><ol><li>å¦‚æœæœ‰accessTokençš„è¯·æ±‚å¤´ï¼ˆå¯ä»¥è‡ªå·²å®šä¹‰åå­—ï¼‰ï¼Œå–å‡ºtokenï¼Œè§£ætokenï¼Œè§£ææˆåŠŸè¯´æ˜tokenæ­£ç¡®ï¼Œå°†è§£æå‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯æ”¾åˆ°SpringSecurityçš„ä¸Šä¸‹æ–‡ä¸­</li><li>å¦‚æœæœ‰accessTokençš„è¯·æ±‚å¤´ï¼Œè§£ætokenå¤±è´¥ï¼ˆæ— æ•ˆtokenï¼Œæˆ–è€…è¿‡æœŸå¤±æ•ˆï¼‰ï¼Œå–ä¸åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œæ”¾è¡Œ</li><li>æ²¡æœ‰accessTokençš„è¯·æ±‚å¤´ï¼Œæ”¾è¡Œ</li></ol><p>è¿™é‡Œå¯èƒ½æœ‰äººä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆtokenå¤±æ•ˆéƒ½è¦æ”¾è¡Œå‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºSpringSecurityä¼šè‡ªå·±å»åšç™»å½•çš„è®¤è¯å’Œæƒé™çš„æ ¡éªŒï¼Œé çš„å°±æ˜¯æˆ‘ä»¬æ”¾åœ¨SpringSecurityä¸Šä¸‹æ–‡ä¸­çš„<code>SecurityContextHolder.getContext().setAuthentication(authentication);</code>ï¼Œæ²¡æœ‰æ‹¿åˆ°<code>authentication</code>ï¼Œæ”¾è¡Œäº†ï¼ŒSpringSecurityè¿˜æ˜¯ä¼šèµ°åˆ°è®¤è¯å’Œæ ¡éªŒï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‘ç°æ²¡æœ‰ç™»å½•æ²¡æœ‰æƒé™ã€‚</p><blockquote><p>æ—§ç‰ˆæœ¬, æœ€æ–°åœ¨åº•éƒ¨</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>filter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">SecurityConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetailService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * è¿‡æ»¤å™¨,åœ¨è¯·æ±‚è¿‡æ¥çš„æ—¶å€™,è§£æè¯·æ±‚å¤´ä¸­çš„token,å†è§£ætokenå¾—åˆ°ç”¨æˆ·ä¿¡æ¯,å†å­˜åˆ°SecurityContextHolderä¸­
 * <span class="token keyword">@author</span> zzzgd
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerJwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CustomerUserDetailService</span> customerUserDetailService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        
    	<span class="token comment">//è¯·æ±‚å¤´ä¸º accessToken</span>
    	<span class="token comment">//è¯·æ±‚ä½“ä¸º Bearer token</span>

    	<span class="token class-name">String</span> authHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>authHeader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TOKEN_SPLIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">final</span> <span class="token class-name">String</span> authToken <span class="token operator">=</span> authHeader<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TOKEN_SPLIT<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">JwtTokenUtil</span><span class="token punctuation">.</span><span class="token function">parseTokenGetUsername</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> customerUserDetailService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userDetails <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span>
                            <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    authentication<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h3 id="_1-7-å®ç°userdetailsæ‰©å……å­—æ®µ" tabindex="-1"><a class="header-anchor" href="#_1-7-å®ç°userdetailsæ‰©å……å­—æ®µ" aria-hidden="true">#</a> 1.7 å®ç°UserDetailsæ‰©å……å­—æ®µ</h3><p>è¿™ä¸ªæ¥å£è¡¨ç¤ºçš„ç”¨æˆ·ä¿¡æ¯ï¼ŒSpringSecurityé»˜è®¤å®ç°äº†ä¸€ä¸ªUserï¼Œä¸è¿‡å­—æ®µå¯¥å¯¥æ— å‡ ï¼Œåªæœ‰usernameï¼Œpasswordè¿™äº›ï¼Œè€Œä¸”åé¢è·å–ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™ä¹Ÿæ˜¯è·å–çš„UserDetailã€‚</p><p>äºæ˜¯æˆ‘ä»¬å°†è‡ªå·±çš„æ•°æ®åº“çš„Userä½œä¸ºæ‹“å±•ï¼Œè‡ªå·±å®ç°è¿™ä¸ªæ¥å£ã€‚<strong>ç»§æ‰¿çš„æ˜¯æ•°æ®åº“å¯¹åº”çš„Userï¼Œè€Œä¸æ˜¯SpringSecurityçš„User</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">UserConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collection</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * CustomerUserDetails
 *
 * <span class="token keyword">@author</span> zgd
 * <span class="token keyword">@date</span> 2019/7/17 15:29
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerUserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">CustomerUserDetails</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthorities</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authorities <span class="token operator">=</span> authorities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * æ·»åŠ ç”¨æˆ·æ‹¥æœ‰çš„æƒé™å’Œè§’è‰²
   * <span class="token keyword">@return</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authorities<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * è´¦æˆ·æ˜¯å¦è¿‡æœŸ
   * <span class="token keyword">@return</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * æ˜¯å¦ç¦ç”¨
   * <span class="token keyword">@return</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * å¯†ç æ˜¯å¦è¿‡æœŸ
   * <span class="token keyword">@return</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * æ˜¯å¦å¯ç”¨
   * <span class="token keyword">@return</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">UserConstants</span><span class="token punctuation">.</span>USER_STATUS_NORMAL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br></div></div><h3 id="_1-8-å®ç°userdetailsservice" tabindex="-1"><a class="header-anchor" href="#_1-8-å®ç°userdetailsservice" aria-hidden="true">#</a> 1.8 å®ç°UserDetailsService</h3><p>SpringSecurityåœ¨ç™»å½•çš„æ—¶å€™ï¼Œå›å»æ•°æ®åº“ï¼ˆæˆ–å…¶ä»–æ¥æºï¼‰ï¼Œæ ¹æ®usernameè·å–æ­£ç¡®çš„userä¿¡æ¯ï¼Œå°±ä¼šæ ¹æ®è¿™ä¸ªserviceç±»ï¼Œæ‹¿åˆ°ç”¨æˆ·çš„ä¿¡æ¯å’Œæƒé™ã€‚æˆ‘ä»¬è‡ªå·±å®ç°</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>dao<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IUserService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">CollectionUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> zgd
 * <span class="token keyword">@date</span> 2019/1/16 16:27
 * <span class="token keyword">@description</span> è‡ªå·±å®ç°UserDetailService,ç”¨ä¸SpringSecurityè·å–ç”¨æˆ·ä¿¡æ¯
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerUserDetailService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">IUserService</span> userService<span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * è·å–ç”¨æˆ·ä¿¡æ¯,ç„¶åäº¤ç»™springå»æ ¡éªŒæƒé™
   * <span class="token keyword">@param</span> <span class="token parameter">username</span>
   * <span class="token keyword">@return</span>
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">UsernameNotFoundException</span></span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserRoleByUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;ç”¨æˆ·åä¸å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">CustomerUserDetails</span> customerUserDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomerUserDetails</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ç”¨äºæ·»åŠ ç”¨æˆ·çš„æƒé™ã€‚åªè¦æŠŠç”¨æˆ·æƒé™æ·»åŠ åˆ°authorities å°±ä¸‡äº‹å¤§å‰ã€‚</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">&quot;ROLE_&quot;</span><span class="token operator">+</span>r<span class="token punctuation">.</span><span class="token function">getRoleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    customerUserDetails<span class="token punctuation">.</span><span class="token function">setAuthorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;authorities:{}&quot;</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//è¿™é‡Œè¿”å›çš„æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„UserDetail</span>
    <span class="token keyword">return</span> customerUserDetails<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h3 id="_1-9-usersessionservice" tabindex="-1"><a class="header-anchor" href="#_1-9-usersessionservice" aria-hidden="true">#</a> 1.9 userSessionService</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>common<span class="token punctuation">.</span>user</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetails</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>manager<span class="token punctuation">.</span></span><span class="token class-name">RedisManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * CacheUserSessionServiceImpl
 * ä½¿ç”¨rediså®ç°çš„ï¼Œå­˜å‚¨ç”¨æˆ·ä¼šè¯session
 * <span class="token keyword">@author</span> zgd
 * <span class="token keyword">@date</span> 2019/7/19 14:29
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserCacheSessionServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserSessionService</span>  <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisManager</span> redisManager<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> USER_SESSION_PREFIX <span class="token operator">=</span> <span class="token string">&quot;USER-SESSION:&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> USER_TOKEN_TIMESTAMP_PREFIX <span class="token operator">=</span> <span class="token string">&quot;USER-TOKEN-TIMESTAMP:&quot;</span><span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveSession</span><span class="token punctuation">(</span><span class="token class-name">CustomerUserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token keyword">int</span> second<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> userDetails<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_SESSION_PREFIX <span class="token operator">+</span> username<span class="token punctuation">;</span>
    redisManager<span class="token punctuation">.</span><span class="token function">setexToJson</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>second<span class="token punctuation">,</span>userDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">CustomerUserDetails</span> <span class="token function">getSessionByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_SESSION_PREFIX <span class="token operator">+</span> username<span class="token punctuation">;</span>
    <span class="token keyword">return</span> redisManager<span class="token punctuation">.</span><span class="token function">getFromJson</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token class-name">CustomerUserDetails</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroySession</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_SESSION_PREFIX <span class="token operator">+</span> username<span class="token punctuation">;</span>
    <span class="token class-name">String</span> key1 <span class="token operator">=</span> USER_TOKEN_TIMESTAMP_PREFIX <span class="token operator">+</span> username<span class="token punctuation">;</span>
    redisManager<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>key1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveTokenTimestamp</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token keyword">long</span> mills<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_TOKEN_TIMESTAMP_PREFIX <span class="token operator">+</span> username<span class="token punctuation">;</span>
    redisManager<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>mills<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getTokenTimestamp</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> USER_TOKEN_TIMESTAMP_PREFIX <span class="token operator">+</span> username<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>redisManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="_1-10-resonseutil" tabindex="-1"><a class="header-anchor" href="#_1-10-resonseutil" aria-hidden="true">#</a> 1.10 ResonseUtil</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">MapUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResponseUtil</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">ResponseUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">Result</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">out</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token keyword">int</span> statusCode<span class="token punctuation">,</span> <span class="token class-name">Result</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">out</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">outWithHeader</span><span class="token punctuation">(</span><span class="token keyword">int</span> statusCode<span class="token punctuation">,</span> <span class="token class-name">Result</span> result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">out</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> result<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token keyword">int</span> statusCode<span class="token punctuation">,</span> <span class="token class-name">Result</span> result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ServletOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">ServletRequestAttributes</span> servletRequestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span><span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>servletRequestAttributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> servletRequestAttributes<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//å¦‚æœå‘ç°ä¹±ç ,è¿™é‡Œæ³¨é‡Š</span>
          response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            header<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>response<span class="token operator">::</span><span class="token function">setHeader</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var14<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[ResponseUtil] å“åº”å‡ºé”™ &quot;</span><span class="token punctuation">,</span> var14<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var13<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;å…³é—­æµå‡ºé”™ &quot;</span><span class="token punctuation">,</span> var13<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><h2 id="äºŒã€é…ç½®websecurityconfigureradapter" tabindex="-1"><a class="header-anchor" href="#äºŒã€é…ç½®websecurityconfigureradapter" aria-hidden="true">#</a> äºŒã€é…ç½®WebSecurityConfigurerAdapter</h2><p>æˆ‘ä»¬éœ€è¦å°†ä¸Šé¢å®šä¹‰çš„handlerå’Œfilterï¼Œæ³¨å†Œåˆ°SpringSecurityã€‚åŒæ—¶é…ç½®ä¸€äº›æ”¾è¡Œçš„url</p><p><strong>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šå¦‚æœé…ç½®äº†ä¸‹é¢çš„SessionCreationPolicy.STATELESS</strong>ï¼Œåˆ™SpringSecurityä¸ä¼šä¿å­˜sessionä¼šè¯ï¼Œåœ¨<code>/logout</code>ç™»å‡ºçš„æ—¶å€™ä¼šæ‹¿ä¸åˆ°ç”¨æˆ·å®ä½“å¯¹è±¡ã€‚</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>å¦‚æœç™»å‡ºæ³¨é”€ä¸ä¾èµ–SpringSecurityï¼Œå¹¶ä¸”sessionäº¤ç»™redisçš„tokenæ¥ç®¡ç†çš„è¯ï¼Œå¯ä»¥æŒ‰ä¸Šé¢çš„é…ç½®ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>encoder<span class="token punctuation">.</span></span><span class="token class-name">MyAesPasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>encoder<span class="token punctuation">.</span></span><span class="token class-name">MyEmptyPasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">CustomerJwtAuthenticationTokenFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetailService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManagerBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>method<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableGlobalMethodSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">WebSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * @Author: zgd
 * @Date: 2019/1/15 17:42
 * @Description:
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">// æ§åˆ¶@Securedæƒé™æ³¨è§£</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

  <span class="token doc-comment comment">/**
   * è¿™é‡Œéœ€è¦äº¤ç»™springæ³¨å…¥,è€Œä¸æ˜¯ç›´æ¥new
   */</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerUserDetailService</span> customerUserDetailService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerAuthenticationFailHandler</span> customerAuthenticationFailHandler<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerAuthenticationSuccessHandler</span> customerAuthenticationSuccessHandler<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerJwtAuthenticationTokenFilter</span> customerJwtAuthenticationTokenFilter<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerRestAccessDeniedHandler</span> customerRestAccessDeniedHandler<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerLogoutSuccessHandler</span> customerLogoutSuccessHandler<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">CustomerAuthenticationEntryPoint</span> customerAuthenticationEntryPoint<span class="token punctuation">;</span>


 
  <span class="token doc-comment comment">/**
   * è¯¥æ–¹æ³•å®šä¹‰è®¤è¯ç”¨æˆ·ä¿¡æ¯è·å–çš„æ¥æºã€å¯†ç æ ¡éªŒçš„è§„åˆ™
   *
   * <span class="token keyword">@param</span> <span class="token parameter">auth</span>
   * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Exception</span></span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//auth.authenticationProvider(myauthenticationProvider)  è‡ªå®šä¹‰å¯†ç æ ¡éªŒçš„è§„åˆ™</span>

    <span class="token comment">//å¦‚æœéœ€è¦æ”¹å˜è®¤è¯çš„ç”¨æˆ·ä¿¡æ¯æ¥æºï¼Œæˆ‘ä»¬å¯ä»¥å®ç°UserDetailsService</span>
    auth<span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>customerUserDetailService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * antMatchers: antçš„é€šé…ç¬¦è§„åˆ™
     * ?	åŒ¹é…ä»»ä½•å•å­—ç¬¦
     * *	åŒ¹é…0æˆ–è€…ä»»æ„æ•°é‡çš„å­—ç¬¦ï¼Œä¸åŒ…å«&quot;/&quot;
     * **	åŒ¹é…0æˆ–è€…æ›´å¤šçš„ç›®å½•ï¼ŒåŒ…å«&quot;/&quot;
     */</span>
    http
            <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    http
            <span class="token comment">//ç™»å½•å,è®¿é—®æ²¡æœ‰æƒé™å¤„ç†ç±»</span>
            <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span>customerRestAccessDeniedHandler<span class="token punctuation">)</span>
            <span class="token comment">//åŒ¿åè®¿é—®,æ²¡æœ‰æƒé™çš„å¤„ç†ç±»</span>
            <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>customerAuthenticationEntryPoint<span class="token punctuation">)</span>
    <span class="token punctuation">;</span>

    <span class="token comment">//ä½¿ç”¨jwtçš„Authentication,æ¥è§£æè¿‡æ¥çš„è¯·æ±‚æ˜¯å¦æœ‰token</span>
    http
            <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>customerJwtAuthenticationTokenFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    http
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//è¿™é‡Œè¡¨ç¤º&quot;/any&quot;å’Œ&quot;/ignore&quot;ä¸éœ€è¦æƒé™æ ¡éªŒ</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/ignore/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/**/register/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// è¿™é‡Œè¡¨ç¤ºä»»ä½•è¯·æ±‚éƒ½éœ€è¦æ ¡éªŒè®¤è¯(ä¸Šé¢é…ç½®çš„æ”¾è¡Œ)</span>


            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//é…ç½®ç™»å½•,æ£€æµ‹åˆ°ç”¨æˆ·æœªç™»å½•æ—¶è·³è½¬çš„urlåœ°å€,ç™»å½•æ”¾è¡Œ</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">//éœ€è¦è·Ÿå‰ç«¯è¡¨å•çš„actionåœ°å€ä¸€è‡´</span>
            <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>customerAuthenticationSuccessHandler<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>customerAuthenticationFailHandler<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">//é…ç½®å–æ¶ˆsessionç®¡ç†,åˆJwtæ¥è·å–ç”¨æˆ·çŠ¶æ€,å¦åˆ™å³ä½¿tokenæ— æ•ˆ,ä¹Ÿä¼šæœ‰sessionä¿¡æ¯,ä¾æ—§åˆ¤æ–­ç”¨æˆ·ä¸ºç™»å½•çŠ¶æ€</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span>

            <span class="token comment">//é…ç½®ç™»å‡º,ç™»å‡ºæ”¾è¡Œ</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span>customerLogoutSuccessHandler<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

<span class="token number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br></div></div><h2 id="ä¸‰ã€å…¶ä»–" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€å…¶ä»–" aria-hidden="true">#</a> ä¸‰ã€å…¶ä»–</h2><p>å¤§æ¦‚åˆ°è¿™å°±å·®ä¸å¤šäº†ï¼Œå¯åŠ¨ï¼Œlocalhost:8080/loginï¼Œä½¿ç”¨postmanï¼Œé‡‡ç”¨form-dataï¼Œpostæäº¤ï¼Œå‚æ•°æ˜¯usernameå’Œpasswordï¼Œè°ƒç”¨ï¼Œè¿”å›tokenã€‚</p><p>å°†tokenæ”¾åœ¨headerä¸­ï¼Œè¯·æ±‚æ¥å£ã€‚ok</p><h3 id="_3-1-ä¸è¶³ä¹‹å¤„" tabindex="-1"><a class="header-anchor" href="#_3-1-ä¸è¶³ä¹‹å¤„" aria-hidden="true">#</a> 3.1 ä¸è¶³ä¹‹å¤„</h3><p>ä¸Šé¢æ˜¯æœ€ç®€å•çš„å¤„ç†ï¼Œè¿˜æœ‰å¾ˆå¤šä¼˜åŒ–çš„åœ°æ–¹ã€‚æ¯”å¦‚</p><ol><li>æ§åˆ¶tokené”€æ¯ï¼Ÿ ä½¿ç”¨redis+tokenç»„åˆï¼Œä¸ä»…è§£ætokenï¼Œè¿˜åˆ¤æ–­redisæ˜¯å¦æœ‰è¿™ä¸ªtokenã€‚æ³¨é”€å’Œä¸»åŠ¨å¤±æ•ˆtokenï¼šåˆ é™¤redisçš„key</li><li>æ§åˆ¶tokenè¿‡æœŸæ—¶é—´ï¼Ÿå¦‚æœç”¨æˆ·åœ¨tokenè¿‡æœŸå‰1ç§’è¿˜åœ¨æ“ä½œï¼Œä¸‹1ç§’å°±éœ€è¦é‡æ–°ç™»å½•ï¼Œè‚¯å®šä¸å¥½ 1ã€è€ƒè™‘åŠ å…¥refreshTokenï¼Œè¿‡æœŸæ—¶é—´æ¯”tokené•¿ï¼Œå‰ç«¯åœ¨æ‹¿åˆ°tokençš„åŒæ—¶è·å–è¿‡æœŸæ—¶é—´ï¼Œåœ¨è¿‡æœŸå‰ä¸€åˆ†é’Ÿç”¨refreshTokenè°ƒç”¨refreshæ¥å£ï¼Œé‡æ–°è·å–æ–°çš„tokenã€‚ 2ã€ å°†è¿”å›çš„jwtTokenè®¾ç½®çŸ­ä¸€ç‚¹çš„è¿‡æœŸæ—¶é—´ï¼Œrediså†å­˜è¿™ä¸ªtokenï¼Œè¿‡æœŸæ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹ã€‚å¦‚æœè¯·æ±‚è¿‡æ¥tokenè¿‡æœŸï¼ŒæŸ¥è¯¢redisï¼Œå¦‚æœredisè¿˜å­˜åœ¨ï¼Œè¿”å›æ–°çš„tokenã€‚ï¼ˆä¸ºä»€ä¹ˆredisçš„è¿‡æœŸæ—¶é—´å¤§äºtokençš„ï¼Ÿå› ä¸ºredisçš„è¿‡æœŸæ˜¯å¯æ§çš„ï¼Œæ‰‹åŠ¨å¯åˆ é™¤ï¼Œä»¥redisçš„ä¸ºå‡†ï¼‰</li><li>æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè¢«<code>OncePerRequestFilter</code> æ‹¦æˆªï¼Œæ¯æ¬¡éƒ½ä¼šè¢«<code>UserDetailService</code>ä¸­çš„è·å–ç”¨æˆ·æ•°æ®è¯·æ±‚æ•°æ®åº“ï¼Œå¯ä»¥è€ƒè™‘åšç¼“å­˜ï¼Œè¿˜æ˜¯ç”¨redisæˆ–è€…ç›´æ¥ä¿å­˜å†…å­˜ä¸­</li></ol><h3 id="_3-2-è§£å†³" tabindex="-1"><a class="header-anchor" href="#_3-2-è§£å†³" aria-hidden="true">#</a> 3.2 è§£å†³</h3><blockquote><p>æ›´æ–° 2019-07-19</p></blockquote><p>è¿™æ˜¯é’ˆå¯¹ä¸Šé¢çš„2.2è¯´çš„ï¼Œä¹Ÿå°±æ˜¯redisæ—¶é—´ä¹…ä¸€ç‚¹ï¼Œjwtè¿‡æœŸåå¦‚æœredisæ²¡è¿‡æœŸï¼Œé¢å‘æ–°çš„jwtã€‚ ä¸è¿‡æ›´æ¨èçš„æ˜¯<strong>å‰ç«¯åˆ¤æ–­è¿‡æœŸæ—¶é—´ï¼Œåœ¨è¿‡æœŸä¹‹å‰è°ƒç”¨refreshæ¥å£æ‹¿åˆ°æ–°çš„jwt</strong>ã€‚</p><p>ä¸ºä»€ä¹ˆè¿™æ ·ï¼Ÿ å¦‚æœredisè¿‡æœŸæ—¶é—´æ˜¯ä¸€å‘¨ï¼Œjwtæ˜¯ä¸€ä¸ªå°æ—¶ï¼Œé‚£ä¹ˆä¸€ä¸ªå°æ—¶åï¼Œæ‹¿ç€è¿™ä¸ªè¿‡æœŸçš„jwtå»è°ƒï¼Œå°±å¯ä»¥æƒ³åˆ›å»ºå¤šå°‘ä¸ªæ–°çš„jwtå°±åˆ›å»ºï¼Œåªè¦æ²¡è¿‡redisçš„è¿‡æœŸæ—¶é—´ã€‚ å½“ç„¶è¿™æ˜¯åœ¨æ²¡å¯¹è¿‡æœŸçš„jwtåšé™åˆ¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¦è€ƒè™‘åšé™åˆ¶ï¼Œæ¯”å¦‚å¯¹redisçš„valueåŠ ä¸€ä¸ªå­—æ®µï¼Œä¿å­˜å½“å‰jwtï¼Œåˆ·æ–°åå°±ç”¨æ–°çš„jwtè¦†ç›–ï¼Œrefreshæ¥å£åˆ¤æ–­å½“å‰çš„è¿‡æœŸjwtæ˜¯ä¸æ˜¯å’Œredisè¿™ä¸ªä¸€æ ·ã€‚</p><p>æ€»ä¹‹è¿˜éœ€è¦åˆ¤æ–­åˆ·æ–°tokençš„æ—¶å€™ï¼Œè¿‡æœŸjwtæ˜¯å¦åˆæ³•çš„é—®é¢˜ã€‚æ€»ä¸èƒ½å»å¹´çš„è¿‡æœŸtokenä¹Ÿæ‹¿æ¥åˆ·æ–°å§ã€‚ è€Œåœ¨è¿‡æœŸå‰å»åˆ·æ–°tokençš„è¯ï¼Œè‡³å°‘ä¸ä¼šå‘ç”Ÿè¿™ç§äº‹æƒ…</p><p>ä¸è¿‡æˆ‘è¿™é‡Œè‡ªå·±å†™demoï¼Œé‡‡ç”¨çš„è¿˜æ˜¯2.2çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¿‡æœŸåç»™ä¸ªæ–°çš„ï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>ç™»å½•åé¢å‘tokenï¼Œtokenæœ‰ä¸ªæ—¶é—´æˆ³ï¼ŒåŒæ—¶ä»¥usernameæ‹¼è£…ä½œä¸ºkeyï¼Œä¿å­˜è¿™ä¸ªæ—¶é—´æˆ³åˆ°ç¼“å­˜ï¼ˆredisï¼Œcacheï¼‰</li><li>è¯·æ±‚æ¥äº†ï¼Œè¿‡æ»¤å™¨è§£ætokenï¼Œæ²¡è¿‡æœŸçš„è¯ï¼Œè¿˜éœ€è¦æ¯”è¾ƒç¼“å­˜ä¸­çš„æ—¶é—´æˆ³å’Œtokençš„æ—¶é—´æˆ³æ˜¯ä¸æ˜¯ä¸€æ · ï¼Œå¦‚æœæ—¶é—´æˆ³ä¸ä¸€æ ·ï¼Œè¯´æ˜è¯¥tokenä¸èƒ½åˆ·æ–°ã€‚æ— è§†</li><li>æ³¨é”€ï¼Œæ¸…é™¤ç¼“å­˜æ•°æ®</li></ol><p>è¿™æ ·å°±å¯ä»¥é¿å…tokenè¿‡æœŸåï¼Œæˆ‘è¿˜èƒ½æ‹¿åˆ°è¿™ä¸ªtokenæ— é™åˆ¶çš„refreshã€‚</p><p>ä¸è¿‡è¿™ä¸ªè¿˜æ˜¯æœ‰ç»†èŠ‚æ–¹é¢é—®é¢˜ï¼Œå¹¶å‘ä¸‹åŒæ—¶åˆ·æ–°tokenè¿™äº›å¹¶æ²¡æœ‰è€ƒè™‘ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹</p><blockquote><p>æ—§ç‰ˆæœ¬, æœ€æ–°åœ¨åº•éƒ¨</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>filter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">SecurityConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetailService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetails</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">UserSessionService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">UserTokenManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Claims</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">ExpiredJwtException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * è¿‡æ»¤å™¨,åœ¨è¯·æ±‚è¿‡æ¥çš„æ—¶å€™,è§£æè¯·æ±‚å¤´ä¸­çš„token,å†è§£ætokenå¾—åˆ°ç”¨æˆ·ä¿¡æ¯,å†å­˜åˆ°SecurityContextHolderä¸­
 * <span class="token keyword">@author</span> zzzgd
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerJwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CustomerUserDetailService</span> customerUserDetailService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserSessionService</span> userSessionService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserTokenManager</span> userTokenManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        
    	<span class="token comment">//è¯·æ±‚å¤´ä¸º accessToken</span>
    	<span class="token comment">//è¯·æ±‚ä½“ä¸º Bearer token</span>

    	<span class="token class-name">String</span> authHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>authHeader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TOKEN_SPLIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">final</span> <span class="token class-name">String</span> authToken <span class="token operator">=</span> authHeader<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TOKEN_SPLIT<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> username<span class="token punctuation">;</span>
            <span class="token class-name">Claims</span> claims<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                claims <span class="token operator">=</span> <span class="token class-name">JwtTokenUtil</span><span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                username <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExpiredJwtException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//tokenè¿‡æœŸ</span>
                claims <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                username <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">CustomerUserDetails</span> userDetails <span class="token operator">=</span> userSessionService<span class="token punctuation">.</span><span class="token function">getSessionByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userDetails <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//sessionæœªè¿‡æœŸï¼Œæ¯”å¯¹æ—¶é—´æˆ³æ˜¯å¦ä¸€è‡´ï¼Œæ˜¯åˆ™é‡æ–°é¢å‘token</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameTimestampToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        userTokenManager<span class="token punctuation">.</span><span class="token function">awardAccessToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//é¿å…æ¯æ¬¡è¯·æ±‚éƒ½è¯·æ±‚æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä»ç¼“å­˜ä¸­æŸ¥è¯¢</span>
            <span class="token class-name">CustomerUserDetails</span> userDetails <span class="token operator">=</span> userSessionService<span class="token punctuation">.</span><span class="token function">getSessionByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//                UserDetails userDetails = customerUserDetailService.loadUserByUsername(username);</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userDetails <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameTimestampToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>claims<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//å¿…é¡»tokenè§£æçš„æ—¶é—´æˆ³å’Œsessionä¿å­˜çš„ä¸€è‡´</span>
                        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span>
                                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        authentication<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * åˆ¤æ–­æ˜¯å¦åŒä¸€ä¸ªæ—¶é—´æˆ³
     * <span class="token keyword">@param</span> <span class="token parameter">username</span> 
     * <span class="token keyword">@param</span> <span class="token parameter">claims</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isSameTimestampToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Claims</span> claims<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> userSessionService<span class="token punctuation">.</span><span class="token function">getTokenTimestamp</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> jwtTimestamp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TIME_STAMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> timestamp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jwtTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">Maps</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">SecurityConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">UserConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ResponseUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>core<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">ResultUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">UserAuthProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">MapUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>checkerframework<span class="token punctuation">.</span>checker<span class="token punctuation">.</span>units<span class="token punctuation">.</span>qual<span class="token punctuation">.</span></span><span class="token class-name">A</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * UserTokenManager
 * tokenç®¡ç†
 *
 * <span class="token keyword">@author</span> zgd
 * <span class="token keyword">@date</span> 2019/7/19 15:25
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserTokenManager</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">UserAuthProperties</span> userAuthProperties<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">UserSessionService</span> userSessionService<span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * é¢å‘token
   * <span class="token keyword">@param</span> <span class="token parameter">principal</span>
   * <span class="token keyword">@author</span> zgd
   * <span class="token keyword">@date</span> 2019/7/19 15:34
   * <span class="token keyword">@return</span> void
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">awardAccessToken</span><span class="token punctuation">(</span><span class="token class-name">CustomerUserDetails</span> principal<span class="token punctuation">,</span><span class="token keyword">boolean</span> isRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//é¢å‘token ç¡®å®šæ—¶é—´æˆ³ï¼Œä¿å­˜åœ¨sessionä¸­å’Œtokenä¸­</span>
    <span class="token keyword">long</span> mill <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userSessionService<span class="token punctuation">.</span><span class="token function">saveSession</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userSessionService<span class="token punctuation">.</span><span class="token function">saveTokenTimestamp</span><span class="token punctuation">(</span>principal<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mill<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> param <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">UserConstants</span><span class="token punctuation">.</span>USER_ID<span class="token punctuation">,</span>principal<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TIME_STAMP<span class="token punctuation">,</span>mill<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JwtTokenUtil</span><span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>principal<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">,</span>userAuthProperties<span class="token punctuation">.</span><span class="token function">getJwtExpirationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMapWithExpectedSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>HEADER<span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> code <span class="token operator">=</span> isRefresh <span class="token operator">?</span> <span class="token number">201</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">outWithHeader</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br></div></div><h5 id="æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#æ›´æ–°" aria-hidden="true">#</a> æ›´æ–°</h5><blockquote><p>2019-09-30</p></blockquote><p>é’ˆå¯¹tokenè§£æçš„è¿‡æ»¤å™¨åšäº†ä¼˜åŒ–:</p><ol><li>å¦‚æœredisçš„sessionæ²¡è¿‡æœŸ, ä½†æ˜¯è¯·æ±‚å¤´çš„tokenè¿‡æœŸäº†, åˆ¤æ–­æ—¶é—´æˆ³ä¸€è‡´å, é¢å‘æ–°tokenå¹¶è¿”å›</li><li>å¦‚æœredisçš„sessionæ²¡è¿‡æœŸ, ä½†æ˜¯è¯·æ±‚å¤´çš„tokenè¿‡æœŸäº†, æ—¶é—´æˆ³ä¸ä¸€è‡´, è¯´æ˜å½“å‰è¯·æ±‚çš„tokenæ— æ³•åˆ·æ–°token, è®¾ç½®å“åº”ç ä¸º401è¿”å›</li><li>å¦‚æœè¯·æ±‚å¤´çš„tokenè¿‡æœŸäº†, ä½†æ˜¯redisçš„sessionå¤±æ•ˆæˆ–æœªæ‰¾åˆ°, ç›´æ¥æ”¾è¡Œ, äº¤ç»™åé¢çš„æƒé™æ ¡éªŒå¤„ç†(ä¹Ÿå°±æ˜¯æ²¡æœ‰ç»™ä¸Šä¸‹æ–‡<code>SecurityContextHolder</code>è®¾ç½®ç™»å½•ä¿¡æ¯, åé¢å¦‚æœåˆ¤æ–­è¿™ä¸ªè¯·æ±‚ç¼ºå°‘æƒé™ä¼šè‡ªè¡Œå¤„ç†)</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>filter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>constants<span class="token punctuation">.</span></span><span class="token class-name">SecurityConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ResponseUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token class-name">JwtTokenUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>core<span class="token punctuation">.</span>error<span class="token punctuation">.</span></span><span class="token class-name">ErrorCodeConstants</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>core<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">ResultUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetailService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetails</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">UserSessionService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>zgd<span class="token punctuation">.</span>shop<span class="token punctuation">.</span>web<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>user<span class="token punctuation">.</span></span><span class="token class-name">UserTokenManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">Claims</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token class-name">ExpiredJwtException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * è¿‡æ»¤å™¨,åœ¨è¯·æ±‚è¿‡æ¥çš„æ—¶å€™,è§£æè¯·æ±‚å¤´ä¸­çš„token,å†è§£ætokenå¾—åˆ°ç”¨æˆ·ä¿¡æ¯,å†å­˜åˆ°SecurityContextHolderä¸­
 * <span class="token keyword">@author</span> zzzgd
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerJwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CustomerUserDetailService</span> customerUserDetailService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserSessionService</span> userSessionService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserTokenManager</span> userTokenManager<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        
    	<span class="token comment">//è¯·æ±‚å¤´ä¸º accessToken</span>
    	<span class="token comment">//è¯·æ±‚ä½“ä¸º Bearer token</span>

    	<span class="token class-name">String</span> authHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>authHeader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TOKEN_SPLIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//è¯·æ±‚å¤´æœ‰token</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> authToken <span class="token operator">=</span> authHeader<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TOKEN_SPLIT<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> username<span class="token punctuation">;</span>
            <span class="token class-name">Claims</span> claims<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                claims <span class="token operator">=</span> <span class="token class-name">JwtTokenUtil</span><span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                username <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExpiredJwtException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//tokenè¿‡æœŸ</span>
                claims <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                username <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">CustomerUserDetails</span> userDetails <span class="token operator">=</span> userSessionService<span class="token punctuation">.</span><span class="token function">getSessionByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userDetails <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//sessionæœªè¿‡æœŸï¼Œæ¯”å¯¹æ—¶é—´æˆ³æ˜¯å¦ä¸€è‡´ï¼Œæ˜¯åˆ™é‡æ–°é¢å‘token</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameTimestampToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getClaims</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        userTokenManager<span class="token punctuation">.</span><span class="token function">awardAccessToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//ç›´æ¥è®¾ç½®å“åº”ç ä¸º201,ç›´æ¥è¿”å›</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token comment">//æ—¶é—´æˆ³ä¸ä¸€è‡´.æ— æ•ˆtoken,æ— æ³•åˆ·æ–°token,å“åº”ç 401,å‰ç«¯è·³è½¬ç™»å½•é¡µ</span>
                        <span class="token class-name">ResponseUtil</span><span class="token punctuation">.</span><span class="token function">out</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token class-name">ErrorCodeConstants</span><span class="token punctuation">.</span>REQUIRED_LOGIN_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">//ç›´æ¥æ”¾è¡Œ,äº¤ç»™åé¢çš„handlerå¤„ç†,å¦‚æœå½“å‰è¯·æ±‚æ˜¯éœ€è¦è®¿é—®æƒé™,åˆ™ä¼šç”±CustomerRestAccessDeniedHandlerå¤„ç†</span>
                    chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//é¿å…æ¯æ¬¡è¯·æ±‚éƒ½è¯·æ±‚æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä»ç¼“å­˜ä¸­æŸ¥è¯¢</span>
            <span class="token class-name">CustomerUserDetails</span> userDetails <span class="token operator">=</span> userSessionService<span class="token punctuation">.</span><span class="token function">getSessionByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//                UserDetails userDetails = customerUserDetailService.loadUserByUsername(username);</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>userDetails <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameTimestampToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>claims<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//å¿…é¡»tokenè§£æçš„æ—¶é—´æˆ³å’Œsessionä¿å­˜çš„ä¸€è‡´</span>
                        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span>
                                <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        authentication<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * åˆ¤æ–­æ˜¯å¦åŒä¸€ä¸ªæ—¶é—´æˆ³
     * <span class="token keyword">@param</span> <span class="token parameter">username</span>
     * <span class="token keyword">@param</span> <span class="token parameter">claims</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isSameTimestampToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Claims</span> claims<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Long</span> timestamp <span class="token operator">=</span> userSessionService<span class="token punctuation">.</span><span class="token function">getTokenTimestamp</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> jwtTimestamp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>TIME_STAMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> timestamp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>jwtTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/xlc520/xlc520.github.io/edit/master/notes/java/SpringBoot+SpringSecurityå‰åç«¯åˆ†ç¦»+Jwtçš„æƒé™è®¤è¯.md" rel="noopener noreferrer" target="_blank" arialabel="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/3/20 06:45:22</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2215400217@qq.com">xlc520</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/java/SpringBoot%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%8A%A8%E6%80%81%E7%AE%A1%E7%90%86%E9%80%9A%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.html" class="nav-link prev" arialabel="SpringBoot å®šæ—¶ä»»åŠ¡åŠ¨æ€ç®¡ç†é€šç”¨è§£å†³æ–¹æ¡ˆ"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->SpringBoot å®šæ—¶ä»»åŠ¡åŠ¨æ€ç®¡ç†é€šç”¨è§£å†³æ–¹æ¡ˆ</div></a><a href="/java/%E5%B0%86Bean%E6%94%BE%E5%85%A5Spring%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%847%E7%A7%8D%E6%96%B9%E5%BC%8F.html" class="nav-link next" arialabel="SpringBootå°†Beanæ”¾å…¥Springå®¹å™¨ä¸­çš„äº”ç§æ–¹å¼"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">SpringBootå°†Beanæ”¾å…¥Springå®¹å™¨ä¸­çš„äº”ç§æ–¹å¼<!----></div></a></nav><!----><!----></main><!--]--><footer class="footer-wrapper"><div class="footer">ä¸¤æƒ…è‹¥æ˜¯ä¹…é•¿æ—¶ï¼Œåˆå²‚åœ¨æœæœæš®æš®</div><div class="copyright">Copyright Â© 2022 xlc520</div></footer></div><!--]--><!----><!--[--><!-- Root element of PhotoSwipe. Must have class pswp. --><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><!-- Background of PhotoSwipe. 
    Itâ€™s a separate element, as animating opacity is faster than rgba().--><div class="pswp__bg"></div><!-- Slides wrapper with overflow:hidden. --><div class="pswp__scroll-wrap"><!-- Container that holds slides. PhotoSwipe keeps only 3 slides in DOM to save memory. --><div class="pswp__container"><!-- donâ€™t modify these 3 pswp__item elements, data is added later on --><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. --><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><!--  Controls are self-explanatory. Order can be changed. --><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="å…³é—­"></button><button class="pswp__button pswp__button--share" title="åˆ†äº«"></button><button class="pswp__button pswp__button--fs" title="åˆ‡æ¢å…¨å±"></button><button class="pswp__button pswp__button--zoom" title="ç¼©æ”¾"></button><!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR --><!-- element will get class pswp__preloader--active when preloader is running --><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="ä¸Šä¸€ä¸ª (å·¦ç®­å¤´)"></button><button class="pswp__button pswp__button--arrow--right" title="ä¸‹ä¸€ä¸ª (å³ç®­å¤´)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><!--]--><!--]--></div>
    <script type="module" src="/assets/app.1ee1cb07.js" defer></script>
  </body>
</html>
