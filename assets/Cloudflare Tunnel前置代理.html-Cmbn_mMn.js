import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as t,c as r,b as i,n as o,g as p,r as s,a as h}from"./app-DDjfOKh-.js";const d={};function u(c,e){const a=s("VPBanner"),l=s("Share");return t(),r("div",null,[i(a,o(p({title:"Cloudflare Tunnel前置代理",content:"Cloudflare Tunnel前置代理",logo:null,color:"var(--banner-text)",background:"rgba(217, 244, 208, 0.5)",actions:[{text:"Cloudflare Tunnel前置代理",link:"/linux/Cloudflare Tunnel前置代理"}]})),null,16),e[0]||(e[0]=h(`<h1 id="cloudflare-tunnel前置代理" tabindex="-1"><a class="header-anchor" href="#cloudflare-tunnel前置代理"><span>Cloudflare Tunnel前置代理</span></a></h1><p>赛博大善人的 Cloudflare Tunnel(前 Argo Tunnel) 只需要一个域名、一个 Cloudflare 帐号便可以将服务接入到 Cloudflare 的网络，提供了非常方便的内网穿透方式， 同时还提供了 ZeroTrust、防护等功能， 而这一切基本几乎都是免费的，相信看到此文的小伙伴已经薅上一段时间了，不过由于 Cloudflare Tunnel 官方的服务节点分布有限，在部分时空/场景下，Tunnel 连通性会面临一些挑战， 这时候要是能够通过前置代理去连接到 Tunnel 服务，问题便能得到解决，可惜<a href="https://github.com/cloudflare/cloudflared/issues/350#issuecomment-1706842883" target="_blank" rel="noopener noreferrer">官方目前并没打算支持这个特性</a>。</p><p>目前比较有效的方案是 Xiaomage 同学的： <a href="https://blog.xmgspace.me/archives/cloudflare-tunnel-via-proxy.html" target="_blank" rel="noopener noreferrer">Cloudflare Tunnel速度慢？尝试给它加个前置代理提高速度</a> ，不过这种方式对动手能力还是有点要求的，同时也增加了部署的依赖。 　　这里看到社区有一个来自 <a href="https://github.com/Asutorufa" target="_blank" rel="noopener noreferrer">Asutorufa</a> 的PR: <a href="https://github.com/cloudflare/cloudflared/pull/1020" target="_blank" rel="noopener noreferrer">http2 tunnel support</a> 经过测试，发现基本能实现这个需求。 根据这个思路，<a href="https://github.com/AlliotTech/cloudflared_proxy" target="_blank" rel="noopener noreferrer">Fork 仓库</a>后简单的加了个 GitHub Action 打包发布 Docker 镜像。</p><p>顺便放一个 Docker compose 片段：</p><div class="language-yaml line-numbers-mode" data-highlighter="shiki" data-ext="yaml" data-title="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cloudflare-tunnel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ghcr.io/alliottech/cloudflared_proxy:latest</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # network_mode: &quot;host&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    container_name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">cloudflare-tunnel</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    hostname</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">cloudflare-tunnel</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    restart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">unless-stopped</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    command</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">tunnel run  --protocol http2</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    links</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;nginx&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    volumes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/localtime:/etc/localtime:ro</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    environment</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;all_proxy=socks5://127.0.0.1:123&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;TUNNEL_TRANSPORT_PROTOCOL=http2&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;TUNNEL_TOKEN=xxxxxxxx&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>直接替换之前的官方镜像片段为上述后即可愉快的玩耍了, 切记 <code>TUNNEL_TRANSPORT_PROTOCOL=http2</code> 这个环境变量是必须的:</p><blockquote><p>https://github.com/cloudflare/cloudflared/pull/1020#issuecomment-1706843025 This is something that we don’t actually want to support within cloudflared. Furthermore, http2 transport only has a subset of features that cloudflared allows and the official transport to use should be QUIC, which wouldn’t work for the SOCKS proxy.</p></blockquote><p>当然，你也可以选择 Clone 仓库后，手动打包二进制直接使用：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>make cloudflared TARGET_ARCH=amd64 TARGET_OS=linux</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>使用编译后的 <code>cloudflared</code>:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>all_proxy=socks5://127.0.0.1:123 ./cloudflared tunnel run --protocol http2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="ref" tabindex="-1"><a class="header-anchor" href="#ref"><span>Ref</span></a></h3><p><a href="https://blog.xmgspace.me/archives/cloudflare-tunnel-via-proxy.html" target="_blank" rel="noopener noreferrer">Cloudflare Tunnel速度慢？尝试给它加个前置代理提高速度</a><a href="https://www.emengweb.com/p/%E6%8E%A2%E7%B4%A2Cloudflared-Tunnel-%E5%8E%9FArgo-Tunnel-%E5%AE%9E%E7%8E%B0%E4%B8%AD%E9%97%B4%E5%B1%82%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F" target="_blank" rel="noopener noreferrer">探索Cloudflared Tunnel</a></p><p>https://www.iots.vip/post/cloudflare-tunnel-proxy-support.html</p>`,14)),i(l,{colorful:"",service:"email,qq,qzone,qrcode,weibo,telegram,twitter"})])}const g=n(d,[["render",u],["__file","Cloudflare Tunnel前置代理.html.vue"]]),f=JSON.parse('{"path":"/linux/Cloudflare%20Tunnel%E5%89%8D%E7%BD%AE%E4%BB%A3%E7%90%86.html","title":"Cloudflare Tunnel前置代理","lang":"zh-CN","frontmatter":{"title":"Cloudflare Tunnel前置代理","excerpt":null,"description":"Cloudflare Tunnel前置代理","date":"2024-09-12T00:00:00.000Z","category":"Linux","tag":"Linux","author":"xlc520","article":true,"timeline":true,"icon":"linux","head":[["meta",{"property":"og:url","content":"https://blog.ciberviler.top/linux/Cloudflare%20Tunnel%E5%89%8D%E7%BD%AE%E4%BB%A3%E7%90%86.html"}],["meta",{"property":"og:site_name","content":"StudyNote - 丰富的知识笔记库"}],["meta",{"property":"og:title","content":"Cloudflare Tunnel前置代理"}],["meta",{"property":"og:description","content":"Cloudflare Tunnel前置代理"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-15T14:38:03.000Z"}],["meta",{"property":"article:author","content":"xlc520"}],["meta",{"property":"article:tag","content":"Linux"}],["meta",{"property":"article:published_time","content":"2024-09-12T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-11-15T14:38:03.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Cloudflare Tunnel前置代理\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-09-12T00:00:00.000Z\\",\\"dateModified\\":\\"2024-11-15T14:38:03.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xlc520\\"}]}"]]},"headers":[{"level":3,"title":"Ref","slug":"ref","link":"#ref","children":[]}],"git":{"createdTime":1731681483000,"updatedTime":1731681483000,"contributors":[{"name":"xlc","email":"2215400217@qq.com","commits":1}]},"readingTime":{"minutes":2.09,"words":627},"filePathRelative":"linux/Cloudflare Tunnel前置代理.md","localizedDate":"2024年9月12日","excerpt":""}');export{g as comp,f as data};
