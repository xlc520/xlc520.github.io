(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{542:function(a,s,n){"use strict";n.r(s);var t=n(1),e=Object(t.a)({},(function(){var a=this,s=a.$createElement,n=a._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[n("h1",{attrs:{id:"nginx安装web应用防火墙"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx安装web应用防火墙"}},[a._v("#")]),a._v(" Nginx安装Web应用防火墙")]),a._v(" "),n("p",[a._v("LNMP一键安装包 ngx_lua_waf waf(web应用防火墙) 安装设置。WAF中文名是Web应用防火墙，WAF能够根据规则拦截SQL注入、恶意请求、黑客扫描等HTTP请求从而保护WEB应用的安全。")]),a._v(" "),n("p",[a._v("今天我们要说的是一个比较简单好用的基于lua的waf：ngx_lua_waf。它是一个基于lua-nginx-module(openresty)的web应用防火墙，https://github.com/loveshell/ngx_lua_waf。")]),a._v(" "),n("p",[a._v("用途：")]),a._v(" "),n("ul",[n("li",[a._v("防止sql注入，本地包含，部分溢出，fuzzing测试，xss，SSRF等web攻击")]),a._v(" "),n("li",[a._v("防止svn/备份之类文件泄漏")]),a._v(" "),n("li",[a._v("防止ApacheBench之类压力测试工具的攻击")]),a._v(" "),n("li",[a._v("屏蔽常见的扫描黑客工具，扫描器")]),a._v(" "),n("li",[a._v("屏蔽异常的网络请求")]),a._v(" "),n("li",[a._v("屏蔽图片附件类目录php执行权限")]),a._v(" "),n("li",[a._v("防止webshell上传")])]),a._v(" "),n("h2",{attrs:{id:"ngx-lua-waf安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ngx-lua-waf安装"}},[a._v("#")]),a._v(" ngx_lua_waf安装")]),a._v(" "),n("h3",{attrs:{id:"_1-lua支持安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-lua支持安装"}},[a._v("#")]),a._v(" 1. lua支持安装")]),a._v(" "),n("p",[a._v("LNMP一键安装包从1.5开始增加了lua支持的选项，可以通过修改lnmp.conf中Enable_Nginx_Lua后的参数为 y 来启用lua，如果没安装lnmp，修改lnmp.conf后保存，安装完lnmp就是支持lua的，如果已经安装好lnmp，也是按前面修改lnmp.conf")]),a._v(" "),n("p",[a._v("然后lnmp安装包目录下运行"),n("code",[a._v("./upgrade.sh nginx")]),a._v(" 升级nginx")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("./upgrade.sh nginx\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br")])]),n("p",[a._v("输入当前nginx版本号或更新的nginx版本号，升级完成就是支持lua的了。如果出错，请重新下载完整版的LNMP安装包lnmp**-full.tar.gz，再次安装。")]),a._v(" "),n("h3",{attrs:{id:"_2-安装ngx-lua-waf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-安装ngx-lua-waf"}},[a._v("#")]),a._v(" 2. 安装ngx_lua_waf")]),a._v(" "),n("p",[a._v("下载安装ngx_lua_waf：")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("wget https://github.com/loveshell/ngx_lua_waf/archive/master.zip -O ngx_lua_waf.zip\nunzip ngx_lua_waf.zip\nmv ngx_lua_waf-master /usr/local/nginx/conf/waf\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br")])]),n("p",[a._v("nginx上设置并启用ngx_lua_waf")]),a._v(" "),n("p",[a._v("编辑 "),n("code",[a._v("/usr/local/nginx/conf/nginx.conf")]),a._v("在"),n("strong",[a._v("http段")]),a._v("的 "),n("code",[a._v("server_tokens off")]),a._v("; 下面添加如下代码：")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v('lua_package_path "/usr/local/nginx/conf/waf/?.lua";\nlua_shared_dict limit 10m;\ninit_by_lua_file /usr/local/nginx/conf/waf/init.lua;\n')])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br")])]),n("p",[a._v("修改完成保存")]),a._v(" "),n("p",[a._v("如果要想在某个虚拟主机启用ngx_lua_waf可以修改对应虚拟主机的server段，在该server段中 root 网站目录行下面添加如下代码：")]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("access_by_lua_file /usr/local/nginx/conf/waf/waf.lua;\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br")])]),n("p",[a._v("修改完成保存")]),a._v(" "),n("p",[a._v("测试nginx配置文件："),n("code",[a._v("/usr/local/nginx/sbin/nginx -t")]),a._v("\n重载nginx配置生效："),n("code",[a._v("/usr/local/nginx/sbin/nginx -s reload")])]),a._v(" "),n("p",[a._v("如果测试和重载都没报错就已经生效。")]),a._v(" "),n("p",[a._v("可以通过访问 http://域名/test.php?id=../etc/passwd 来测试")]),a._v(" "),n("p",[a._v("提示：您的请求带有>不合法参数，已被网站管理员设置拦截！说明已经正确设置")]),a._v(" "),n("h3",{attrs:{id:"_3-ngx-lua-waf防火墙配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-ngx-lua-waf防火墙配置"}},[a._v("#")]),a._v(" 3. ngx_lua_waf防火墙配置")]),a._v(" "),n("p",[a._v("ngx_lua_waf配置文件位置："),n("code",[a._v("/usr/local/nginx/conf/waf/config.lua")]),a._v("\nngx_lua_waf配置文件参数说明：")]),a._v(" "),n("div",{staticClass:"language-lua line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-lua"}},[n("code",[a._v("RulePath "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("local")]),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("conf"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("waf"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("wafconf"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("”\n–规则存放目录\nattacklog "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “off”\n–是否开启攻击信息记录，需要配置logdir\nlogdir "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("usr"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("local")]),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("nginx"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("logs"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("hack"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),a._v("”\n–log存储目录，该目录需要用户自己新建，切需要nginx用户的可写权限\nUrlDeny"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("”on”\n–是否拦截url访问\nRedirect"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("”on”\n–是否拦截后重定向\nCookieMatch "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “on”\n–是否拦截cookie攻击\npostMatch "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “on”\n–是否拦截post攻击\nwhiteModule "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “on”\n–是否开启URL白名单\nblack_fileExt"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("“php”"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("”jsp”"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n–填写不允许上传文件后缀类型\nipWhitelist"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("“"),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("127.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v(".1")]),a._v("”"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n–ip白名单，多个ip用逗号分隔\nipBlocklist"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("“"),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("1.0")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v(".0")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v(".1")]),a._v("″"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n–ip黑名单，多个ip用逗号分隔\nCCDeny"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("”on”\n–是否开启拦截cc攻击"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("需要nginx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("conf的http段增加lua_shared_dict limit 10m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nCCrate "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" “"),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("100")]),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("/")]),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("”\n–设置cc攻击频率，单位为秒"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("\n–默认"),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("分钟同一个IP只能请求同一个地址"),n("span",{pre:!0,attrs:{class:"token number"}},[a._v("100")]),a._v("次\nhtml"),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),n("span",{pre:!0,attrs:{class:"token string"}},[a._v("[[Please go away~~]]")]),a._v(" –警告内容"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("可在中括号内自定义\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br"),n("span",{staticClass:"line-number"},[a._v("19")]),n("br"),n("span",{staticClass:"line-number"},[a._v("20")]),n("br"),n("span",{staticClass:"line-number"},[a._v("21")]),n("br"),n("span",{staticClass:"line-number"},[a._v("22")]),n("br"),n("span",{staticClass:"line-number"},[a._v("23")]),n("br"),n("span",{staticClass:"line-number"},[a._v("24")]),n("br"),n("span",{staticClass:"line-number"},[a._v("25")]),n("br"),n("span",{staticClass:"line-number"},[a._v("26")]),n("br"),n("span",{staticClass:"line-number"},[a._v("27")]),n("br"),n("span",{staticClass:"line-number"},[a._v("28")]),n("br")])]),n("p",[a._v("备注:不要乱动双引号，区分大小写")]),a._v(" "),n("p",[a._v("ngx_lua_waf安装到此结束。")]),a._v(" "),n("h3",{attrs:{id:"_4-ngx-lua-waf效果图"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-ngx-lua-waf效果图"}},[a._v("#")]),a._v(" 4. ngx_lua_waf效果图")]),a._v(" "),n("p",[n("img",{attrs:{src:"/static/img/ngcb15.webp",alt:"ngx_lua_waf waf(web应用防火墙)"}}),a._v(" "),n("img",{attrs:{src:"/static/img/ngcb15-16419157753881.webp",alt:"ngx_lua_waf waf(web应用防火墙)"}})])])}),[],!1,null,null,null);s.default=e.exports}}]);