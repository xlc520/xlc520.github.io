import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as s,a as e}from"./app-BRQZ0-Iq.js";const t={},i=e(`<h1 id="通过-nginx-来实现禁止国外-ip-访问网站" tabindex="-1"><a class="header-anchor" href="#通过-nginx-来实现禁止国外-ip-访问网站"><span>通过 Nginx 来实现禁止国外 IP 访问网站</span></a></h1><p>前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此 我决定 禁止国外 IP 来访问我的网站</p><p>想要实现这个功能有很多方法，下面我就来介绍基于 NGINX 的 ngx_http_geoip2 模块 来禁止国外 IP 访问网站</p><p><strong>一、安装 geoip2 扩展依赖</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj ~<span class="token punctuation">]</span><span class="token comment"># yum install libmaxminddb-devel -y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>二、下载 ngx_http_geoip2_module 模块</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj tmp<span class="token punctuation">]</span><span class="token comment">#  git clone https://github.com/leev/ngx_http_geoip2_module.git</span>
<span class="token punctuation">[</span>ro tmp<span class="token punctuation">]</span><span class="token comment"># </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>三、解压模块到指定路径</strong></p><p>我这里解压到/usr/local 目录下</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj tmp<span class="token punctuation">]</span><span class="token comment"># mv ngx_http_geoip2_module/ /usr/local/</span>
<span class="token punctuation">[</span>root@fxkj local<span class="token punctuation">]</span><span class="token comment"># ll ngx_http_geoip2_module/</span>
total <span class="token number">60</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1199</span> Aug <span class="token number">13</span> <span class="token number">17</span>:20 config
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">1311</span> Aug <span class="token number">13</span> <span class="token number">17</span>:20 LICENSE
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">23525</span> Aug <span class="token number">13</span> <span class="token number">17</span>:20 ngx_http_geoip2_module.c
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">21029</span> Aug <span class="token number">13</span> <span class="token number">17</span>:20 ngx_stream_geoip2_module.c
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">3640</span> Aug <span class="token number">13</span> <span class="token number">17</span>:20 README.md
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>四、安装 nginx 模块</strong></p><p>首先说明下环境，我的 nginx 版本是 1.16 , 在网上查了下 安装 ngx_http_geoip2 模块至少需要 1.18 版本及以上，因此此次安装我是 升级 nginx1.18，添加 ngx_http_geoip2 模块。</p><ul><li>下载 nginx 1.18 版本</li></ul><div class="language-plain line-numbers-mode" data-ext="plain" data-title="plain"><pre class="language-plain"><code>[root@fxkj tmp]# wget http://nginx.org/download/nginx-1.18.0.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>解压 nginx1.18 软件包并 升级为 nginx1.18 ，添加 ngx_http_geoip2 模块</li></ul><p>需要注意：</p><p><strong>1、升级 nginx, 添加 nginx 模块 只需要 编译 然后 make 不需要 make instll 不然线上的 nginx 会被新版本 nginx 完完整整的替换掉</strong></p><p><strong>2、编译前 需要看下 nginx 当前安装了哪些模块</strong></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>**<span class="token punctuation">[</span>root@fxkj tmp<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -V**</span>

**nginx version: nginx/1.16.0**

**built by gcc <span class="token number">4.8</span>.5 <span class="token number">20150623</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.8</span>.5-39<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span>**

**built with OpenSSL <span class="token number">1.0</span>.2k-fips <span class="token number">26</span> Jan <span class="token number">2017</span>**

**TLS SNI support enabled**

**configure arguments: --with-http_stub_status_module <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nginx <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-http_ssl_module --with-stream**
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译安装</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj tmp<span class="token punctuation">]</span><span class="token comment"># tar -xf nginx-1.18.0.tar.gz </span>
<span class="token punctuation">[</span>root@fxkj tmp<span class="token punctuation">]</span><span class="token comment"># cd nginx-1.18.0/</span>
<span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># ./configure --with-http_stub_status_module \\</span>
 <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nginx <span class="token punctuation">\\</span>
 <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-http_ssl_module --with-stream <span class="token punctuation">\\</span>
 --add-module<span class="token operator">=</span>/usr/local/ngx_http_geoip2_module
<span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># make</span>
<span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># cp /usr/loca/nginx/sbin/nginx /usr/loca/nginx/sbin/nginx1.16    #备份</span>
<span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># cp objs/nginx /usr/local/nginx/sbin/    #用新的去覆盖旧的</span>
<span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># pkill nginx     #杀死nginx</span>
<span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx    #再次启动Nginx</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看 nginx 版本 以及安装的模块</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj nginx-1.18.0<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -V</span>

nginx version: nginx/1.18.0

built by gcc <span class="token number">4.8</span>.5 <span class="token number">20150623</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.8</span>.5-39<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span>

built with OpenSSL <span class="token number">1.0</span>.2k-fips <span class="token number">26</span> Jan <span class="token number">2017</span>

TLS SNI support enabled

configure arguments: --with-http_stub_status_module <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nginx <span class="token parameter variable">--user</span><span class="token operator">=</span>nginx <span class="token parameter variable">--group</span><span class="token operator">=</span>nginx --with-http_ssl_module --with-stream **--add-module<span class="token operator">=</span>/usr/local/ngx_http_geoip2_module**
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>五、下载最新的 IP 地址数据库文件</strong></p><p>模块安装成功后，还要在 Nginx 里指定数据库，在安装运行库时默认安装了两个，位于 /usr/share/GeoIP/ 目录下，一个只有 IPv4，一个包含 IPv4 和 IPv6：</p><p>登录 &lt;www.maxmind.com&gt; 网址，创建账户 下载最新的库文件（账户创建就不演示了）</p><p>点击左侧 ，Download Files</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/a965a80a0e354dde96ba5fa1091cf86f.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>选择 GeoLite2 Country ，点击 Download GZIP 下载即可</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/c3e087baa970419593541115de1ad8be.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>上传到 /usr/share/GeoIP/ 下并解压</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj local<span class="token punctuation">]</span><span class="token comment"># cd /usr/share/GeoIP/</span>
<span class="token punctuation">[</span>root@fxkj GeoIP<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">69612</span>
lrwxrwxrwx. <span class="token number">1</span> root root       <span class="token number">17</span> Mar  <span class="token number">7</span>  <span class="token number">2019</span> GeoIP.dat -<span class="token operator">&gt;</span> GeoIP-initial.dat
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">1242574</span> Oct <span class="token number">30</span>  <span class="token number">2018</span> GeoIP-initial.dat
lrwxrwxrwx. <span class="token number">1</span> root root       <span class="token number">19</span> Mar  <span class="token number">7</span>  <span class="token number">2019</span> GeoIPv6.dat -<span class="token operator">&gt;</span> GeoIPv6-initial.dat
-rw-r--r--. <span class="token number">1</span> root root  <span class="token number">2322773</span> Oct <span class="token number">30</span>  <span class="token number">2018</span> GeoIPv6-initial.dat
-rw-r--r--  <span class="token number">1</span> root root  <span class="token number">3981623</span> Aug <span class="token number">12</span> 02:37 GeoLite2-Country.mmdb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>六、配置 nginx 配置文件</strong></p><p><strong>修改前 先备份配置文件</strong></p><p>[root@fxkj ~]# cp /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf-bak</p><p>[root@fxkj ~]# vim /usr/local/nginx/conf/nginx.conf</p><p>在 http 中添加 几行，定义数据库文件位置</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>geoip2 /usr/share/GeoIP/GeoLite2-City.mmdb <span class="token punctuation">{</span>
auto_reload 5m<span class="token punctuation">;</span>
<span class="token variable">$geoip2_data_country_code</span> country iso_code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  map <span class="token variable">$geoip2_data_country_code</span> <span class="token variable">$allowed_country</span> <span class="token punctuation">{</span>
                default <span class="token function">yes</span><span class="token punctuation">;</span>
                CN no<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/bfc6d7c990cf41b08b13280b8ee9f0e8.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>在 server 中的 location 下 添加 条件</p><p>如果满足 IP 是国外 IP 就 执行下面的 return 动作，我这里定义了 3 种, 注释了其中两个。</p><p>当访问 IP 是国外 IP ，直接返回 404</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$allowed_country</span> <span class="token operator">=</span> <span class="token function">yes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment"># return https://www.baidu.com;</span>
       <span class="token comment"># return /home/japan;</span>
        <span class="token builtin class-name">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/58effbcb1b4d4422b637a238d8371051.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>修改完毕后， 检测下配置文件，重新加载下 nginx</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@fxkj ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -t</span>
nginx: the configuration <span class="token function">file</span> /usr/local/nginx/conf/nginx.conf syntax is ok
nginx: configuration <span class="token function">file</span> /usr/local/nginx/conf/nginx.conf <span class="token builtin class-name">test</span> is successful
<span class="token punctuation">[</span>roo@fxkj ~<span class="token punctuation">]</span><span class="token comment"># /usr/local/nginx/sbin/nginx -s reload</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>7、模拟测试验证</strong></p><p><strong>使用海外节点的服务器去访问网站</strong></p><p>这里我的 IP 是 来自于韩国</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/fca231769f3c40458a321bdca7c356f1.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>可以看到访问网站报错 404 Not Found</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/ac732b838fd84cf9a1ba52a27c13d76d.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>我们再来看下 nginx 的访问日志</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token string">&quot;13.125.1.194 - - [14/Aug/2020:16:15:51 +0800] &quot;</span>GET /favicon.ico HTTP/1.1<span class="token string">&quot; **404** 548 &quot;</span>https://www.fxkjnj.com/<span class="token string">&quot; &quot;</span>Mozilla/5.0 <span class="token punctuation">(</span>Windows NT <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit/537.36 <span class="token punctuation">(</span>KHTML, like Gecko<span class="token punctuation">)</span> Chrome/84.0.4147.125 Safari/537.36&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/e74537e1a7b4476098d4e68a38203704.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>到此 我们通过 Nginx 来实现禁止国外 IP 访问网站 就结束了</p>`,56),o=[i];function p(l,c){return a(),s("div",null,o)}const d=n(t,[["render",p],["__file","通过Nginx来实现禁止国外IP访问网站.html.vue"]]),g=JSON.parse('{"path":"/dev/%E9%80%9A%E8%BF%87Nginx%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%A6%81%E6%AD%A2%E5%9B%BD%E5%A4%96IP%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99.html","title":"通过Nginx来实现禁止国外IP访问网站","lang":"zh-CN","frontmatter":{"author":"xlc520","title":"通过Nginx来实现禁止国外IP访问网站","excerpt":null,"description":"通过 Nginx 来实现禁止国外 IP 访问网站 前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此 我决定 禁止国外 IP 来访问我的网站 想要实现这个功能有很多方法，下面我就来介绍基于 NGINX 的 ngx_http_geoip2 模块 来...","date":"2022-06-19T00:00:00.000Z","category":"Java","tag":"Java","article":true,"timeline":true,"icon":"java","head":[["meta",{"property":"og:url","content":"https://blog.ciberviler.top/dev/%E9%80%9A%E8%BF%87Nginx%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%A6%81%E6%AD%A2%E5%9B%BD%E5%A4%96IP%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99.html"}],["meta",{"property":"og:site_name","content":"StudyNote - 丰富的知识笔记库"}],["meta",{"property":"og:title","content":"通过Nginx来实现禁止国外IP访问网站"}],["meta",{"property":"og:description","content":"通过 Nginx 来实现禁止国外 IP 访问网站 前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此 我决定 禁止国外 IP 来访问我的网站 想要实现这个功能有很多方法，下面我就来介绍基于 NGINX 的 ngx_http_geoip2 模块 来..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://bitbucket.org/xlc520/blogasset/raw/main/images3/a965a80a0e354dde96ba5fa1091cf86f.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-04-27T13:32:36.000Z"}],["meta",{"property":"article:author","content":"xlc520"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:published_time","content":"2022-06-19T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-04-27T13:32:36.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"通过Nginx来实现禁止国外IP访问网站\\",\\"image\\":[\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/a965a80a0e354dde96ba5fa1091cf86f.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/c3e087baa970419593541115de1ad8be.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/bfc6d7c990cf41b08b13280b8ee9f0e8.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/58effbcb1b4d4422b637a238d8371051.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/fca231769f3c40458a321bdca7c356f1.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/ac732b838fd84cf9a1ba52a27c13d76d.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/e74537e1a7b4476098d4e68a38203704.png\\"],\\"datePublished\\":\\"2022-06-19T00:00:00.000Z\\",\\"dateModified\\":\\"2024-04-27T13:32:36.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xlc520\\"}]}"]]},"headers":[],"git":{"createdTime":1654224367000,"updatedTime":1714224756000,"contributors":[{"name":"xlc520","email":"2215400217@qq.com","commits":5},{"name":"xlc","email":"2215400217@qq.com","commits":2}]},"readingTime":{"minutes":3.99,"words":1197},"filePathRelative":"dev/通过Nginx来实现禁止国外IP访问网站.md","localizedDate":"2022年6月19日","autoDesc":true}');export{d as comp,g as data};
