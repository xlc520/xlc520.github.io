import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as a,c as s,a as e}from"./app-41defce9.js";const t={},p=e(`<h1 id="金额计算bigdecimal及踩坑" tabindex="-1"><a class="header-anchor" href="#金额计算bigdecimal及踩坑" aria-hidden="true">#</a> 金额计算BigDecimal及踩坑</h1><p>除非在一些非常简单的场景，结算汇金类的业务也不会直接用<code>BigDecimal</code>来计算金额，原因有两点：</p><ol><li><code>BigDecimal</code>里面还是有很多隐蔽的坑的</li><li><code>BigDecimal</code>没有提供金额的单位</li></ol><h2 id="_1-bigdecimal中的五个容易踩的坑" tabindex="-1"><a class="header-anchor" href="#_1-bigdecimal中的五个容易踩的坑" aria-hidden="true">#</a> 1. <code>BigDecimal</code>中的五个容易踩的坑</h2><h3 id="_1-1-new-bigdecimal-还是bigdecimal-valueof" tabindex="-1"><a class="header-anchor" href="#_1-1-new-bigdecimal-还是bigdecimal-valueof" aria-hidden="true">#</a> 1.1 <code>new BigDecimal()</code>还是<code>BigDecimal#valueOf()</code>？</h3><p>先看下面这段代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> bd1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigDecimal</span> bd2 <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;bd1 = &quot;</span> <span class="token operator">+</span> bd1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;bd2 = &quot;</span> <span class="token operator">+</span> bd2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出到控制台的结果是：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>bd1 = 0.01000000000000000020816681711721685132943093776702880859375
bd2 = 0.01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>造成这种差异的原因是0.1这个数字计算机是无法精确表示的，送给<code>BigDecimal</code>的时候就已经丢精度了，而<code>BigDecimal#valueOf</code>的实现却完全不同</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">BigDecimal</span> <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token keyword">double</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Reminder: a zero double returns &#39;0.0&#39;, so we cannot fastpath</span>
    <span class="token comment">// to use the constant ZERO.  This might be important enough to</span>
    <span class="token comment">// justify a factory approach, a cache, or a few private</span>
    <span class="token comment">// constants, later.</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它使用了浮点数相应的字符串来构造<code>BigDecimal</code>对象，因此避免了精度问题。所以大家要尽量要使用字符串而不是浮点数去构造<code>BigDecimal</code>对象，如果实在不行，就使用<code>BigDecimal#valueOf()</code>方法吧。</p><h3 id="_1-2-等值比较" tabindex="-1"><a class="header-anchor" href="#_1-2-等值比较" aria-hidden="true">#</a> 1.2 等值比较</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> bd1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigDecimal</span> bd2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bd1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>bd2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bd1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>bd2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>控制台的输出将会是：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>false
0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>究其原因是，<code>BigDecimal</code>中<code>equals</code>方法的实现会比较两个数字的精度，而<code>compareTo</code>方法则只会比较数值的大小。</p><h3 id="_1-3-bigdecimal并不代表无限精度" tabindex="-1"><a class="header-anchor" href="#_1-3-bigdecimal并不代表无限精度" aria-hidden="true">#</a> 1.3 <code>BigDecimal</code>并不代表无限精度</h3><p>先看这段代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigDecimal</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;3.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// results in the following exception.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果会抛出异常：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java.lang.ArithmeticException: Non-terminating decimal expansion; no exact representable decimal result.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>关于这个异常，Oracle的官方文档有具体说明</p><p>If the quotient has a nonterminating decimal expansion and the operation is specified to return an exact result, an ArithmeticException is thrown. Otherwise, the exact result of the division is returned, as done for other operations.</p><p>大意是，如果除法的商的结果是一个无限小数但是我们期望返回精确的结果，那程序就会抛出异常。回到我们的这个例子，我们需要告诉<code>JVM</code>我们不需要返回精确的结果就好了</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;1.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigDecimal</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">&quot;3.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token comment">// 0.33</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-bigdecimal转回string要小心" tabindex="-1"><a class="header-anchor" href="#_1-4-bigdecimal转回string要小心" aria-hidden="true">#</a> 1.4 <code>BigDecimal</code>转回<code>String</code>要小心</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> d <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">12334535345456700.12345634534534578901</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> out <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Or perform any formatting that needs to be done</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1.23345353454567E+16</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到结果已经被转换成了科学计数法，可能这个并不是预期的结果<code>BigDecimal</code>有三个方法可以转为相应的字符串类型，切记不要用错：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 有必要时使用科学计数法</span>
<span class="token class-name">String</span> <span class="token function">toPlainString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 不使用科学计数法</span>
<span class="token class-name">String</span> <span class="token function">toEngineeringString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 工程计算中经常使用的记录数字的方法，与科学计数法类似，但要求10的幂必须是3的倍数</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-执行顺序不能调换-乘法交换律失效" tabindex="-1"><a class="header-anchor" href="#_1-5-执行顺序不能调换-乘法交换律失效" aria-hidden="true">#</a> 1.5 执行顺序不能调换（乘法交换律失效）</h3><p>乘法满足交换律是一个常识，但是在计算机的世界里，会出现不满足乘法交换律的情况</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BigDecimal</span> a <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigDecimal</span> b <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BigDecimal</span> c <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0.990</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">RoundingMode</span><span class="token punctuation">.</span><span class="token constant">HALF_UP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1.00</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>别小看这这0.01的差别，在汇金领域，会产生非常大的金额差异。</p><h2 id="_2-最佳实践" tabindex="-1"><a class="header-anchor" href="#_2-最佳实践" aria-hidden="true">#</a> 2. 最佳实践</h2><p>关于金额计算，很多业务团队会基于<code>BigDecimal</code>再封装一个<code>Money</code>类，其实我们直接可以用一个半官方的<code>Money</code>类：JSR 354 ,虽然没能在<code>Java 9</code>中成为<code>Java</code>标准，很有可能集成到后续的<code>Java</code>版本中成为官方库。</p><h3 id="_2-1-maven坐标" tabindex="-1"><a class="header-anchor" href="#_2-1-maven坐标" aria-hidden="true">#</a> 2.1 <code>maven</code>坐标</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.javamoney<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>moneta<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-新建money类" tabindex="-1"><a class="header-anchor" href="#_2-2-新建money类" aria-hidden="true">#</a> 2.2 新建<code>Money</code>类</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CurrencyUnit</span> cny <span class="token operator">=</span> <span class="token class-name">Monetary</span><span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Money</span> money <span class="token operator">=</span> <span class="token class-name">Money</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> cny<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 或者 Money money = Money.of(1.0, &quot;CNY&quot;);</span>
<span class="token comment">//System.out.println(money);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-金额运算" tabindex="-1"><a class="header-anchor" href="#_2-3-金额运算" aria-hidden="true">#</a> 2.3 金额运算</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CurrencyUnit</span> cny <span class="token operator">=</span> <span class="token class-name">Monetary</span><span class="token punctuation">.</span><span class="token function">getCurrency</span><span class="token punctuation">(</span><span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Money</span> oneYuan <span class="token operator">=</span> <span class="token class-name">Money</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> cny<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Money</span> threeYuan <span class="token operator">=</span> oneYuan<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Money</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CNY 3</span>
<span class="token class-name">Money</span> tenYuan <span class="token operator">=</span> oneYuan<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CNY 10</span>
<span class="token class-name">Money</span> fiveFen <span class="token operator">=</span> oneYuan<span class="token punctuation">.</span><span class="token function">divide</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CNY 0.5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-比较相等" tabindex="-1"><a class="header-anchor" href="#_2-4-比较相等" aria-hidden="true">#</a> 2.4 比较相等</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Money</span> fiveFen <span class="token operator">=</span> <span class="token class-name">Money</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CNY 0.5</span>
<span class="token class-name">Money</span> anotherFiveFen <span class="token operator">=</span> <span class="token class-name">Money</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0.50</span><span class="token punctuation">,</span> <span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// CNY 0.50</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fiveFen<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>anotherFiveFen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，这个类对金额做了显性的抽象，增加了金额的单位，也避免了直接使用<code>BigDecimal</code>的一些坑。</p>`,45),c=[p];function o(l,i){return a(),s("div",null,c)}const k=n(t,[["render",o],["__file","金额计算BigDecimal及踩坑.html.vue"]]);export{k as default};
