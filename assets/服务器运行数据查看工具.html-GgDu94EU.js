import{_ as e}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as n,a as s}from"./app-Clq2mtAP.js";const i={},t=s(`<h1 id="服务器运行数据查看工具" tabindex="-1"><a class="header-anchor" href="#服务器运行数据查看工具"><span>服务器运行数据查看工具</span></a></h1><p>我们开发的软件服务需要在服务器上运行，所以服务器性能代表了软件的性能上限，因此服务器性能调优是个十分重要的环节，然而大部分同学对服务器性能调优关注的较少，今天从 3 个部分对服务器性能调优进行介绍，分别是：服务器配置选择，服务器负载分析，服务器内核参数调优。</p><h2 id="服务器配置选择" tabindex="-1"><a class="header-anchor" href="#服务器配置选择"><span><strong>服务器配置选择</strong></span></a></h2><p>服务器一般是由 CPU、内存、磁盘和网卡组成，因此选择服务器配置就是选择 CPU 核数、内存大小、磁盘大小及类型、网络带宽。但是，服务器配置的选择是很难标准化的，也就是说很难推断出“一台需要达到 1000TPS 的后端服务器”的配置应该是什么样的。因为软件的最终运行性能与软件的实现方式是紧密相关的，即使是同一个后端应用程序中的两个接口，由于具体功能的差别，性能也会有所差别。</p><p>因此，服务器配置的选择应该基于具体的测试结果。一开始可以选用配置较低的服务器做调优和测试，并以该服务器的测试结果作为选择服务器的依据。</p><p>以一个订单业务为例，经过测试后，一台配置为 4 核 CPU 、16GB 内存、10Mbps 带宽、50GB 机械磁盘的服务器的测试结果为：支持 50 并发量和 300TPS 吞吐量（增大并发量后会出现超时报错）。而在压力测试过程中， CPU 的使用率接近 75%，内存使用率在 50％以下，带宽使用率在 50％以下，除去日志以外无磁盘操作。</p><p>因此可以认为，一台配置为 4 核 CPU ( CPU 使用率需要在 75％以下）、8GB 内存（内存使用率可以接近 100%)、 5Mbps 带宽（带宽使用率可以接近 100%）的服务器，可以满足订单接口支持 50 并发量、300TPS 吞吐量的压力。</p><p>如果需要达到 200 并发数、2400TPS 吞吐量的目标的话，则需要 8 台配置为 4 核 CPU 、8GB 内存、5Mbps 带宽的服务器，或者 1 台配置为 32 核 CPU 、64GB 内存、40Mbps 带宽的服务器。当然，最终的服务器配置还是需要通过测试来验证。</p><blockquote><p>注意：在以上订单接口的例子中，后端服务器和数据库等服务器需要一起调试，避免后端服务器性能过剩，而数据库等服务器性能不足的情况发生。另外，以上选择服务器配置的方法不一定适用于所有场景，请斟酌参考。</p></blockquote><h2 id="服务器负载分析" tabindex="-1"><a class="header-anchor" href="#服务器负载分析"><span><strong>服务器负载分析</strong></span></a></h2><p>在性能调优时，需要先对服务器负载进行分析，通常而言，我们主要分析 CPU 使用率、内存使用率、磁盘 I/O，服务器负载和带宽使用情况。</p><h3 id="cpu-使用率" tabindex="-1"><a class="header-anchor" href="#cpu-使用率"><span>CPU 使用率</span></a></h3><p>CPU 使用率反应的是 CPU 的忙碌情况。当 CPU 达到 100%时，部分进程会进入等待状态，CPU 暂时不会对其进行处理。* *在实际情况下，为了应对一下突发性的请求压力，服务器 CPU 使用率一般需要在 75%以下。如果一台服务器的 CPU 使用率多次高于 75%，这时候就考虑增加新的服务器。 **</p><p>监控 CPU 使用率我推荐大家使用<strong>htop</strong>工具，可以非常直观看到 CPU 使用率、内存使用率、及负载等信息。</p><h4 id="使用-htop-查看-cpu-负载" tabindex="-1"><a class="header-anchor" href="#使用-htop-查看-cpu-负载"><span>使用 htop 查看 CPU 负载</span></a></h4><p>首先我们需要安装 htop，以 centos 为例，安装命令如下：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token function">htop</span> <span class="token parameter variable">-y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>安装完成后我们就可以通过<code>htop</code>命令观察 CPU 负载了</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">htop</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>输入<code>htop</code>命令后我们可以很直观的看到 CPU 负载情况，该命令的 CPU 使用率会以多个核作为单位进行显示。操作系统机会自动分配多个核的负载，当所有核的 CPU 使用率都超过 75%时才能认为服务器的 CPU 使用率已经超过 75%。</p><p><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003660.png" alt="服务器运行数据查看工具" loading="lazy">cpu 负载</p><p>如上图所示，这是一个 4 核 CPU 服务器，在截图的时候其中 3 核 CPU 使用率都超过了 75%，再观察一会发现所有 CPU 的使用率都在 85%左右徘徊，说明 CPU 负载很高了，需要考虑增加新的服务器。</p><h3 id="内存使用率" tabindex="-1"><a class="header-anchor" href="#内存使用率"><span>内存使用率</span></a></h3><p>内存使用率反应的是内存的使用情况。内存用于存放程序的代码及数据，一般分为物理内存和虚拟内存，其中物理内存指的是服务器的内存，而虚拟内存指的是硬盘的一块空间。当物理内存使用率达到 100%时将会使用虚拟内存。需要注意的是，虚拟内存的读写速度远远低于物理内存，如果程序被放在了虚拟内存执行，那么程序的执行效率会变得很低。</p><p><strong>一般而言，服务器的物理内存应该保持在 80%以下，虚拟内存使用率保持在 0%。</strong></p><p>服务器内存使用情况还是可以通过 hop 工具进行查看</p><p><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003661.png" alt="服务器运行数据查看工具" loading="lazy">内存使用率</p><p>上面显示了服务器的内存使用情况：总内存 16G，使用了 10G 左右，内存使用率 62%，可以继续使用，同时关闭了 Swap 虚拟内存。</p><p>在下<code>MEM%</code>栏中显示了单个进程的内存使用率。</p><h3 id="磁盘-i-o" tabindex="-1"><a class="header-anchor" href="#磁盘-i-o"><span>磁盘 I/O</span></a></h3><p>磁盘 I/O 指的是磁盘的读写，在软件系统中，日志、文件操作、数据库操作都会造成磁盘读写压力，其中又以数据库操作为甚，在高并发情况下往往数据库会首先成为系统的瓶颈。</p><p>磁盘监控我推荐大家使用 iostat 工具，可以很方便查看磁盘的使用情况。</p><h4 id="使用-iostat-查看磁盘-i-o" tabindex="-1"><a class="header-anchor" href="#使用-iostat-查看磁盘-i-o"><span>使用 iostat 查看磁盘 I/O</span></a></h4><p>首先我们需要安装<code>iostat</code>，以 centos 为例，安装命令如下：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> sysstat <span class="token parameter variable">-y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>安装完成后我们就可以通过<code>iostat</code>命令磁盘使用情况了。</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 查看磁盘总体读写情况， 1代表每1秒读取一次数据</span>
iostat <span class="token parameter variable">-x</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003662.png" alt="服务器运行数据查看工具" loading="lazy">磁盘 IO</p><p>输入<code>iostat</code>命令后，磁盘总体读写情况如上所示。磁盘负载主要关注 2 个指标：<code>%idle</code>，<code>%util</code></p><ul><li><code>%idle</code>:表示 CPU<strong>除去等待磁盘 I/O 以外</strong>的空闲时间百分比，这个指标应该要保证在 70%以上</li><li><code>%util</code>:该设备用于 I/O 操作的时间百分比，这个指标需要保证在 70%以下，当到达 100%时表示已经满负载。为了降低磁盘负载，可以采用性能更高的磁盘（OSD，PCIE）或者降低磁盘的操作频率（异步写、合并写）</li></ul><h3 id="平均负载" tabindex="-1"><a class="header-anchor" href="#平均负载"><span>平均负载</span></a></h3><p>平均负载指的是单位时间内平均的活跃进程数，是一个表示服务器负载的指标。一般情况下需要保证平均负载的值小于当前服务器的 CPU 核数。</p><p>同样的，查看服务器平均负载我们也可以使用<code>htop</code>命令</p><p><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003663.png" alt="服务器运行数据查看工具" loading="lazy"> 在这里我们主要关注<code>Load average</code>指标，上图有 3 个数字，分别代表 1 分钟，5 分钟，15 分钟的平均负载。</p><p>一般情况下服务器的平均负载需要小于当前服务器的 CPU 核数，为了应对突发状况，服务器的平均负载应该在 75%即 3 以下，很显然，上图这台服务器平均负载超过了 75%，需要考虑提升性能了。</p><h3 id="网络使用情况" tabindex="-1"><a class="header-anchor" href="#网络使用情况"><span>网络使用情况</span></a></h3><p>网络使用情况也是监控的重要指标。当带宽不足时会大大增加请求的响应时间。为了防止突发性并发压力，应该保证服务器的带宽使用率在 80%以上。这里需要注意的是，物理网卡限制了服务器所能使用的最大宽带。</p><p>查看网络使用情况我推荐使用<code>nload</code>工具。</p><h4 id="使用-nload-查看网络" tabindex="-1"><a class="header-anchor" href="#使用-nload-查看网络"><span>使用 nload 查看网络</span></a></h4><p>首先需要安装 nload，以 centos 为例</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> nload <span class="token parameter variable">-y</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>安装完成后我们直接运行<code>nload</code></p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>nload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003664.png" alt="服务器运行数据查看工具" tabindex="0" loading="lazy"><figcaption>服务器运行数据查看工具</figcaption></figure><p>输入<code>nload</code>命令后，网络使用情况如上图所示。其中，网络使用情况分为流入网卡的数据与流出网卡的数据。流入网卡的对应下行带宽的网速，流出网卡的数据对应上行带宽的网速。如果 “当前网速” 持续接近 “最大网速” 时，代表带宽使用率已经接近 100%。</p><p>指标说明：</p><ul><li>Curr：当前网速</li><li>Avg：平均网速</li><li>Min：最小网速</li><li>Max：最大网速</li><li>Ttl：总流量</li></ul><h2 id="服务器内核参数调优" tabindex="-1"><a class="header-anchor" href="#服务器内核参数调优"><span><strong>服务器内核参数调优</strong></span></a></h2><p>光有强大的物理性能是不够的，还需要对内核参数进行调优，这样才能在高并发压力下充分体现服务器应有的性能。当然，并不是所有的服务器都需要做高并发性能调优，一般来说，只需要对要处理高并发请求的服务器进行内核参数调优即可，常见的包括：前端服务器，后端服务器，数据库服务器。</p><p>服务器常见的调优参数主要有两个：单个进程最大打开文件数 和 TCP 相关设置。</p><h3 id="单个进程最大打开文件数" tabindex="-1"><a class="header-anchor" href="#单个进程最大打开文件数"><span>单个进程最大打开文件数</span></a></h3><p>修改单个文件最大打开文件数，只需要编辑<code>/etc/security/limits.conf</code>文件，在文件末尾加上以下四句</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>* soft nofile <span class="token number">65535</span>
* hard nofile <span class="token number">65535</span>
* soft nproc <span class="token number">65535</span>
* hard nproc <span class="token number">65535</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中<code>*</code> 代表所有用户，65536 代表修改的值，重启后生效。</p><h3 id="tcp-相关设置" tabindex="-1"><a class="header-anchor" href="#tcp-相关设置"><span>TCP 相关设置</span></a></h3><p>修改 TCP 相关参数，可以优化 TCP 高并发通信，编辑<code>/etc/sysctl.conf</code>文件，添加以下内容</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 为防止洪水攻击，高并发系统需要将此项关闭</span>
net.ipv4.tcp_syncookies <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment"># 开启TCP连接重用，允许处理TIME-WAIT状态的连接重新用于新的TCP连接</span>
net.ipv4.tcp_tw_reuse <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># 开启快速回收TCP连接中处于TIME-WAIT状态的连接</span>
net.ipv4.tcp_tw_recycle <span class="token operator">=</span> <span class="token number">1</span>

＃修改超时时间（ s <span class="token punctuation">)</span>，该值表示如果连接由本端关闭，则连接处于 FIN-WAIT-2状态的时间为 
net.ipv4.tcp_fin_timeout <span class="token operator">=</span> <span class="token number">30</span>

＃当 keepalive（长连接）启用的时候，TCP发送 keepalive 消息（探测包）的时间间隔（ s <span class="token punctuation">)</span>,默认为2个小时
net.ipv4.tcp_keepalive_time <span class="token operator">=</span><span class="token number">1200</span>

＃服务器对外连接的端口范围，影响该服务器与其他服务器的连接数
net.ipv4.ip_local_port_range <span class="token operator">=</span><span class="token number">102465535</span>

<span class="token comment">#SYN队列的长度，可以容纳更多等待连接的网络连接数，默认为1024 </span>
net.ipv4.tcp_max_syn_backlog <span class="token operator">=</span> <span class="token number">65535</span>

＃保持 TIME_WAIT 状态连接的最大数量，如果超过此值，TIME_WAIT 将立刻被清除并打印警告信息，默认为180000
net.ipv4.tcp_max_tw_buckets <span class="token operator">=</span><span class="token number">5000</span>

＃每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目
net.core.netdev_max_backlog <span class="token operator">=</span><span class="token number">65535</span>

<span class="token comment"># TCP最大连接数</span>
net.core.somaxconn <span class="token operator">=</span> <span class="token number">65535</span>

＃预留用于接收缓冲的内存默认值（字节） 
net.core.rmem_default <span class="token operator">=</span> <span class="token number">8388608</span>

＃预留用于接收缓冲的内存最大值（字节） 
net.core.rmem_max <span class="token operator">=</span> <span class="token number">16777216</span>

＃预留用于发送缓冲的内存默认值（字节） 
net.core.wmem_default <span class="token operator">=</span> <span class="token number">8388608</span>

＃预留用于发送缓冲的内存最大值（字节） 
net.core.wmem_maX <span class="token operator">=</span> <span class="token number">16777216</span>

＃避免时间戳异常
net.ipv4.tcp_timestamps <span class="token operator">=</span> <span class="token number">0</span>

＃系统中最多有多少个 TCP 套接字不被关联到任何一个用户文件句柄上，如果超过这个数字，连接将即刻被复位并打印警告信息，这个限制仅仅是为了防止简单的DoS 攻击
net.ipv4.tcp_max_orphans <span class="token operator">=</span><span class="token number">3276800</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,67),l=[t];function p(c,o){return a(),n("div",null,l)}const m=e(i,[["render",p],["__file","服务器运行数据查看工具.html.vue"]]),u=JSON.parse('{"path":"/linux/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%9F%A5%E7%9C%8B%E5%B7%A5%E5%85%B7.html","title":"服务器运行数据查看工具","lang":"zh-CN","frontmatter":{"author":"xlc520","title":"服务器运行数据查看工具","excerpt":null,"description":"服务器运行数据查看工具 我们开发的软件服务需要在服务器上运行，所以服务器性能代表了软件的性能上限，因此服务器性能调优是个十分重要的环节，然而大部分同学对服务器性能调优关注的较少，今天从 3 个部分对服务器性能调优进行介绍，分别是：服务器配置选择，服务器负载分析，服务器内核参数调优。 服务器配置选择 服务器一般是由 CPU、内存、磁盘和网卡组成，因此选择...","date":"2022-07-10T00:00:00.000Z","category":"Linux","tag":"Linux","article":true,"timeline":true,"icon":"linux","head":[["meta",{"property":"og:url","content":"https://blog.ciberviler.top/linux/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%9F%A5%E7%9C%8B%E5%B7%A5%E5%85%B7.html"}],["meta",{"property":"og:site_name","content":"StudyNote - 丰富的知识笔记库"}],["meta",{"property":"og:title","content":"服务器运行数据查看工具"}],["meta",{"property":"og:description","content":"服务器运行数据查看工具 我们开发的软件服务需要在服务器上运行，所以服务器性能代表了软件的性能上限，因此服务器性能调优是个十分重要的环节，然而大部分同学对服务器性能调优关注的较少，今天从 3 个部分对服务器性能调优进行介绍，分别是：服务器配置选择，服务器负载分析，服务器内核参数调优。 服务器配置选择 服务器一般是由 CPU、内存、磁盘和网卡组成，因此选择..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003660.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-04-27T13:32:36.000Z"}],["meta",{"property":"article:author","content":"xlc520"}],["meta",{"property":"article:tag","content":"Linux"}],["meta",{"property":"article:published_time","content":"2022-07-10T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-04-27T13:32:36.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"服务器运行数据查看工具\\",\\"image\\":[\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003660.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003661.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003662.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003663.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/640-16566648003664.png\\"],\\"datePublished\\":\\"2022-07-10T00:00:00.000Z\\",\\"dateModified\\":\\"2024-04-27T13:32:36.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xlc520\\"}]}"]]},"headers":[{"level":2,"title":"服务器配置选择","slug":"服务器配置选择","link":"#服务器配置选择","children":[]},{"level":2,"title":"服务器负载分析","slug":"服务器负载分析","link":"#服务器负载分析","children":[{"level":3,"title":"CPU 使用率","slug":"cpu-使用率","link":"#cpu-使用率","children":[]},{"level":3,"title":"内存使用率","slug":"内存使用率","link":"#内存使用率","children":[]},{"level":3,"title":"磁盘 I/O","slug":"磁盘-i-o","link":"#磁盘-i-o","children":[]},{"level":3,"title":"平均负载","slug":"平均负载","link":"#平均负载","children":[]},{"level":3,"title":"网络使用情况","slug":"网络使用情况","link":"#网络使用情况","children":[]}]},{"level":2,"title":"服务器内核参数调优","slug":"服务器内核参数调优","link":"#服务器内核参数调优","children":[{"level":3,"title":"单个进程最大打开文件数","slug":"单个进程最大打开文件数","link":"#单个进程最大打开文件数","children":[]},{"level":3,"title":"TCP 相关设置","slug":"tcp-相关设置","link":"#tcp-相关设置","children":[]}]}],"git":{"createdTime":1656665310000,"updatedTime":1714224756000,"contributors":[{"name":"xlc520","email":"2215400217@qq.com","commits":5},{"name":"xlc","email":"2215400217@qq.com","commits":2}]},"readingTime":{"minutes":10.11,"words":3032},"filePathRelative":"linux/服务器运行数据查看工具.md","localizedDate":"2022年7月10日","autoDesc":true}');export{m as comp,u as data};
