import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as n,a as l}from"./app-DWXdHMII.js";const t={};function e(h,i){return a(),n("div",null,i[0]||(i[0]=[l(`<h1 id="通过-nginx-来实现禁止国外-ip-访问网站" tabindex="-1"><a class="header-anchor" href="#通过-nginx-来实现禁止国外-ip-访问网站"><span>通过 Nginx 来实现禁止国外 IP 访问网站</span></a></h1><p>前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此 我决定 禁止国外 IP 来访问我的网站</p><p>想要实现这个功能有很多方法，下面我就来介绍基于 NGINX 的 ngx_http_geoip2 模块 来禁止国外 IP 访问网站</p><p><strong>一、安装 geoip2 扩展依赖</strong></p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj ~]# yum install libmaxminddb-devel -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>二、下载 ngx_http_geoip2_module 模块</strong></p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj tmp]#  git clone https://github.com/leev/ngx_http_geoip2_module.git</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[ro tmp]#</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>三、解压模块到指定路径</strong></p><p>我这里解压到/usr/local 目录下</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" data-title="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj tmp]# mv ngx_http_geoip2_module/ /usr/local/</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj local]# ll ngx_http_geoip2_module/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">total</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  1199</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Aug</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 17:20</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> config</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  1311</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Aug</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 17:20</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> LICENSE</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 23525</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Aug</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 17:20</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ngx_http_geoip2_module.c</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 21029</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Aug</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 17:20</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ngx_stream_geoip2_module.c</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  3640</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Aug</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 13</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 17:20</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> README.md</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>四、安装 nginx 模块</strong></p><p>首先说明下环境，我的 nginx 版本是 1.16 , 在网上查了下 安装 ngx_http_geoip2 模块至少需要 1.18 版本及以上，因此此次安装我是 升级 nginx1.18，添加 ngx_http_geoip2 模块。</p><ul><li>下载 nginx 1.18 版本</li></ul><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" data-title="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>[root@fxkj tmp]# wget http://nginx.org/download/nginx-1.18.0.tar.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>解压 nginx1.18 软件包并 升级为 nginx1.18 ，添加 ngx_http_geoip2 模块</li></ul><p>需要注意：</p><p><strong>1、升级 nginx, 添加 nginx 模块 只需要 编译 然后 make 不需要 make instll 不然线上的 nginx 会被新版本 nginx 完完整整的替换掉</strong></p><p><strong>2、编译前 需要看下 nginx 当前安装了哪些模块</strong></p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**[root@fxkj tmp]# /usr/local/nginx/sbin/nginx -V**</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**nginx version: nginx/1.16.0**</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**built by gcc 4.8.5 20150623 (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Red</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Hat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4.8.5-39</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GCC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)**</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**built with OpenSSL 1.0.2k-fips 26 Jan 2017**</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**TLS SNI support enabled**</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**configure arguments: --with-http_stub_status_module </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">--prefix</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/usr/local/nginx</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --user</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">nginx</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --group</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">nginx</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> --with-http_ssl_module</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --with-stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">**</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译安装</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj tmp]# tar -xf nginx-1.18.0.tar.gz </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj tmp]# cd nginx-1.18.0/</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# ./configure --with-http_stub_status_module </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> --prefix</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/usr/local/nginx</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --group=nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --with-http_ssl_module</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --with-stream</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --add-module=/usr/local/ngx_http_geoip2_module</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# make</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# cp /usr/loca/nginx/sbin/nginx /usr/loca/nginx/sbin/nginx1.16    </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#备份</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# cp objs/nginx /usr/local/nginx/sbin/    </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#用新的去覆盖旧的</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# pkill nginx     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#杀死nginx</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# /usr/local/nginx/sbin/nginx    </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#再次启动Nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看 nginx 版本 以及安装的模块</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj nginx-1.18.0]# /usr/local/nginx/sbin/nginx -V</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> version:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nginx/1.18.0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">built</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> by</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> gcc</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4.8.5</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 20150623</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (Red </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">Hat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 4.8.5-39</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GCC</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">built</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> with</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> OpenSSL</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 1.0.2k-fips</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 26</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Jan</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2017</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">TLS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> SNI</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> support</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enabled</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">configure</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> arguments:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --with-http_stub_status_module</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --prefix=/usr/local/nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --group=nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --with-http_ssl_module</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --with-stream</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> **</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">--add-module=/usr/local/ngx_http_geoip2_module</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">**</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>五、下载最新的 IP 地址数据库文件</strong></p><p>模块安装成功后，还要在 Nginx 里指定数据库，在安装运行库时默认安装了两个，位于 /usr/share/GeoIP/ 目录下，一个只有 IPv4，一个包含 IPv4 和 IPv6：</p><p>登录 &lt;www.maxmind.com&gt; 网址，创建账户 下载最新的库文件（账户创建就不演示了）</p><p>点击左侧 ，Download Files</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/a965a80a0e354dde96ba5fa1091cf86f.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>选择 GeoLite2 Country ，点击 Download GZIP 下载即可</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/c3e087baa970419593541115de1ad8be.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>上传到 /usr/share/GeoIP/ 下并解压</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj local]# cd /usr/share/GeoIP/</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj GeoIP]# ll</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">total</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 69612</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lrwxrwxrwx.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       17</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Mar</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  7</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  2019</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GeoIP.dat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> -&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">GeoIP-initial.dat</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  1242574</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Oct</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  2018</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GeoIP-initial.dat</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lrwxrwxrwx.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">       19</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Mar</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  7</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  2019</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GeoIPv6.dat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> -&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">GeoIPv6-initial.dat</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  2322773</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Oct</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  2018</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GeoIPv6-initial.dat</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">-rw-r--r--</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  3981623</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Aug</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 02:37</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> GeoLite2-Country.mmdb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>六、配置 nginx 配置文件</strong></p><p><strong>修改前 先备份配置文件</strong></p><p>[root@fxkj ~]# cp /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf-bak</p><p>[root@fxkj ~]# vim /usr/local/nginx/conf/nginx.conf</p><p>在 http 中添加 几行，定义数据库文件位置</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">geoip2</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/share/GeoIP/GeoLite2-City.mmdb</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">auto_reload</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 5m</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$geoip2_data_country_code</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> country</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> iso_code</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">  map</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> $geoip2_data_country_code</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> $allowed_country</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                default</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">                CN</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> no</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/bfc6d7c990cf41b08b13280b8ee9f0e8.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>在 server 中的 location 下 添加 条件</p><p>如果满足 IP 是国外 IP 就 执行下面的 return 动作，我这里定义了 3 种, 注释了其中两个。</p><p>当访问 IP 是国外 IP ，直接返回 404</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$allowed_country</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = yes) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       # return https://www.baidu.com;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       # return /home/japan;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 404</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/58effbcb1b4d4422b637a238d8371051.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>修改完毕后， 检测下配置文件，重新加载下 nginx</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@fxkj ~]# /usr/local/nginx/sbin/nginx -t</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> the</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> syntax</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ok</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> configuration</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> file</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/local/nginx/conf/nginx.conf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> test</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> is</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> successful</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[roo@fxkj ~]# /usr/local/nginx/sbin/nginx -s reload</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>7、模拟测试验证</strong></p><p><strong>使用海外节点的服务器去访问网站</strong></p><p>这里我的 IP 是 来自于韩国</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/fca231769f3c40458a321bdca7c356f1.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>可以看到访问网站报错 404 Not Found</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/ac732b838fd84cf9a1ba52a27c13d76d.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>我们再来看下 nginx 的访问日志</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">&quot;13.125.1.194 - - [14/Aug/2020:16:15:51 +0800] &quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /favicon.ico</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> HTTP/1.1&quot; **404** 548 &quot;https://www.fxkjnj.com/&quot; &quot;Mozilla/5.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (Windows </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">NT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Win64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">x64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) AppleWebKit/537.36 (</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">KHTML,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> like</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Gecko</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) Chrome/84.0.4147.125 Safari/537.36</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images3/e74537e1a7b4476098d4e68a38203704.png" alt="通过Nginx来实现禁止国外IP访问网站" tabindex="0" loading="lazy"><figcaption>通过Nginx来实现禁止国外IP访问网站</figcaption></figure><p>到此 我们通过 Nginx 来实现禁止国外 IP 访问网站 就结束了</p>`,56)]))}const r=s(t,[["render",e],["__file","通过Nginx来实现禁止国外IP访问网站.html.vue"]]),d=JSON.parse('{"path":"/dev/%E9%80%9A%E8%BF%87Nginx%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%A6%81%E6%AD%A2%E5%9B%BD%E5%A4%96IP%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99.html","title":"通过Nginx来实现禁止国外IP访问网站","lang":"zh-CN","frontmatter":{"author":"xlc520","title":"通过Nginx来实现禁止国外IP访问网站","excerpt":null,"description":"通过 Nginx 来实现禁止国外 IP 访问网站 前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此 我决定 禁止国外 IP 来访问我的网站 想要实现这个功能有很多方法，下面我就来介绍基于 NGINX 的 ngx_http_geoip2 模块 来...","date":"2022-06-19T00:00:00.000Z","category":"Java","tag":"Java","article":true,"timeline":true,"icon":"java","head":[["meta",{"property":"og:url","content":"https://blog.ciberviler.top/dev/%E9%80%9A%E8%BF%87Nginx%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%A6%81%E6%AD%A2%E5%9B%BD%E5%A4%96IP%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99.html"}],["meta",{"property":"og:site_name","content":"StudyNote - 丰富的知识笔记库"}],["meta",{"property":"og:title","content":"通过Nginx来实现禁止国外IP访问网站"}],["meta",{"property":"og:description","content":"通过 Nginx 来实现禁止国外 IP 访问网站 前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此 我决定 禁止国外 IP 来访问我的网站 想要实现这个功能有很多方法，下面我就来介绍基于 NGINX 的 ngx_http_geoip2 模块 来..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://bitbucket.org/xlc520/blogasset/raw/main/images3/a965a80a0e354dde96ba5fa1091cf86f.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-04-27T13:32:36.000Z"}],["meta",{"property":"article:author","content":"xlc520"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:published_time","content":"2022-06-19T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-04-27T13:32:36.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"通过Nginx来实现禁止国外IP访问网站\\",\\"image\\":[\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/a965a80a0e354dde96ba5fa1091cf86f.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/c3e087baa970419593541115de1ad8be.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/bfc6d7c990cf41b08b13280b8ee9f0e8.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/58effbcb1b4d4422b637a238d8371051.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/fca231769f3c40458a321bdca7c356f1.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/ac732b838fd84cf9a1ba52a27c13d76d.png\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images3/e74537e1a7b4476098d4e68a38203704.png\\"],\\"datePublished\\":\\"2022-06-19T00:00:00.000Z\\",\\"dateModified\\":\\"2024-04-27T13:32:36.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xlc520\\"}]}"]]},"headers":[],"git":{"createdTime":1654224367000,"updatedTime":1714224756000,"contributors":[{"name":"xlc520","email":"2215400217@qq.com","commits":5},{"name":"xlc","email":"2215400217@qq.com","commits":2}]},"readingTime":{"minutes":3.99,"words":1197},"filePathRelative":"dev/通过Nginx来实现禁止国外IP访问网站.md","localizedDate":"2022年6月19日","excerpt":"\\n<p>前言： 先来说说为啥要写这篇文章，之前小编看了下 nginx 的访问日志，发现每天有好多国外的 IP 地址来访问我的网站，并且访问的内容基本上都是恶意的。因此\\n我决定 禁止国外 IP 来访问我的网站</p>","autoDesc":true}');export{r as comp,d as data};
