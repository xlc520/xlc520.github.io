import{_ as p}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as l,c as d,b as n,n as r,g as c,r as a,a as t}from"./app-DWXdHMII.js";const v={};function u(o,s){const i=a("VPBanner"),e=a("Share");return l(),d("div",null,[n(i,r(c({title:"Dockerç¼©å‡Javaé•œåƒå¤§å°",content:"Dockerç¼©å‡Javaé•œåƒå¤§å°",logo:null,color:"var(--banner-text)",background:"rgba(217, 244, 208, 0.5)",actions:[{text:"Dockerç¼©å‡Javaé•œåƒå¤§å°",link:"/dev/Dockerç¼©å‡Javaé•œåƒå¤§å°"}]})),null,16),s[0]||(s[0]=t(`<h1 id="dockerç¼©å‡javaé•œåƒå¤§å°" tabindex="-1"><a class="header-anchor" href="#dockerç¼©å‡javaé•œåƒå¤§å°"><span>Dockerç¼©å‡Javaé•œåƒå¤§å°</span></a></h1><p>åœ¨å½“ä»Šçš„è½¯ä»¶å¼€å‘é¢†åŸŸï¼Œå¾®æœåŠ¡æ¶æ„å’Œå®¹å™¨åŒ–åº”ç”¨å·²æˆä¸ºå¸¸æ€ã€‚éšç€åº”ç”¨ç¨‹åºçš„å¤æ‚æ€§å’Œè§„æ¨¡ä¸æ–­å¢åŠ ï¼Œå¼€å‘è€…ä»¬é¢ä¸´çš„ä¸€ä¸ªä¸»è¦æŒ‘æˆ˜æ˜¯å¦‚ä½•æœ‰æ•ˆç®¡ç†å’Œä¼˜åŒ–åº”ç”¨ç¨‹åºçš„ä½“ç§¯ã€‚å°¤å…¶æ˜¯åœ¨ä½¿ç”¨ Java è¿›è¡Œå¼€å‘æ—¶ï¼Œç”Ÿæˆçš„ Docker é•œåƒå¾€å¾€ä¼šç›¸å¯¹è¾ƒå¤§ï¼Œè¿™ä¸ä»…å½±å“äº†éƒ¨ç½²é€Ÿåº¦ï¼Œè¿˜å¢åŠ äº†ç½‘ç»œä¼ è¾“çš„è´Ÿæ‹…å’Œå­˜å‚¨æˆæœ¬ã€‚å› æ­¤ï¼Œå¦‚ä½•ç²¾ç®€é•œåƒå¤§å°æˆä¸ºäº†æ¯ä¸ªå¼€å‘è€…äºŸå¾…è§£å†³çš„é—®é¢˜ã€‚</p><p>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•é€šè¿‡ jlink å·¥å…·ç”Ÿæˆæ›´å°çš„ Java è¿è¡Œæ—¶ç¯å¢ƒï¼ˆJREï¼‰é•œåƒï¼Œå¹¶è‡ªåŠ¨åŒ–æ•´ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬å°†åˆ†æä¸åŒæ¨¡å—çš„ä¾èµ–å…³ç³»ï¼Œç¡®ä¿ä»…åŒ…æ‹¬è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æœ€å°æ¨¡å—ã€‚é€šè¿‡è¿™æ ·çš„æ–¹æ³•ï¼Œä¸ä»…å¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ•ˆç‡ï¼Œè¿˜èƒ½ä¼˜åŒ–èµ„æºçš„ä½¿ç”¨ï¼Œè®©æˆ‘ä»¬çš„å¾®æœåŠ¡æ›´åŠ è½»é‡ã€çµæ´»ã€‚</p><p>æˆ‘ä»¬å°†ä½¿ç”¨ä¹‹å‰æ–‡ç« ä¸­æ„å»ºçš„Spring Webåº”ç”¨æ¥æ¼”ç¤ºè¿™äº›æŠ€å·§ï¼Œè¯¥æ–‡ç« æ˜¯å…³äºä½¿ç”¨RFC-9457è§„èŒƒè¿›è¡Œé”™è¯¯å¤„ç†ã€‚æˆ‘ä»¬çš„åº”ç”¨ä»…åŒ…å«ä¸¤ä¸ªç«¯ç‚¹ï¼š</p><p>GET /users/</p><p>: æ ¹æ®IDè·å–ç”¨æˆ· POST /users : åˆ›å»ºæ–°ç”¨æˆ·</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>@RestController</span></span>
<span class="line"><span>@RequestMapping(&quot;/api/users&quot;)</span></span>
<span class="line"><span>@RequiredArgsConstructor</span></span>
<span class="line"><span>public class UserController {</span></span>
<span class="line"><span>    private final UserService userService;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @GetMapping(&quot;{id}&quot;)</span></span>
<span class="line"><span>    public User getUser(@PathVariable Long id) {</span></span>
<span class="line"><span>        return userService.getUserById(id)</span></span>
<span class="line"><span>                .orElseThrow(() -&gt; new UserNotFoundException(id, &quot;/api/users&quot;));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @PostMapping</span></span>
<span class="line"><span>    public User createUser(@Valid @RequestBody User user) {</span></span>
<span class="line"><span>        return userService.createUser(user);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çœ‹èµ·æ¥æ²¡ä»€ä¹ˆå§ï¼Ÿä½†æ­£å¦‚ä½ å°†çœ‹åˆ°çš„ï¼Œå³ä½¿æ˜¯æœ€ç®€å•çš„Dockeré•œåƒï¼ˆä¸è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼‰å¤§å°ä¹Ÿå¯èƒ½ç›¸å½“å¤§ã€‚</p><p>æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å…³å¿ƒé•œåƒå¤§å°ï¼Ÿ</p><p>é•œåƒå¤§å°å¯¹ä½ ä½œä¸ºå¼€å‘è€…æˆ–ç»„ç»‡çš„æ€§èƒ½æœ‰æ˜¾è‘—å½±å“ã€‚ç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šä¸ªæœåŠ¡çš„å¤§å‹é¡¹ç›®æ—¶ï¼Œé•œåƒçš„å¤§å°å¯èƒ½ä¼šç›¸å½“åºå¤§ï¼Œè¿™å¯èƒ½ä¼šè®©ä½ èŠ±è´¹å¤§é‡çš„é‡‘é’±å’Œæ—¶é—´ã€‚</p><p>ä¸€äº›é¿å…å¤§å‹é•œåƒçš„åŸå› åŒ…æ‹¬ï¼š</p><ul><li>ç£ç›˜ç©ºé—´ï¼šä½ åœ¨Dockeræ³¨å†Œè¡¨å’Œç”Ÿäº§æœåŠ¡å™¨ä¸Šæµªè´¹äº†ç£ç›˜ç©ºé—´ã€‚</li><li>æ„å»ºæ—¶é—´å»¶é•¿ï¼šé•œåƒè¶Šå¤§ï¼Œæ„å»ºå’Œæ¨é€é•œåƒæ‰€éœ€çš„æ—¶é—´è¶Šé•¿ã€‚</li><li>å®‰å…¨æ€§ï¼šé•œåƒè¶Šå¤§ï¼Œä¾èµ–é¡¹è¶Šå¤šï¼Œæ”»å‡»é¢ä¹Ÿè¶Šå¤§ã€‚</li><li>å¸¦å®½ï¼šé•œåƒè¶Šå¤§ï¼Œä»æ³¨å†Œè¡¨æ‹‰å–å’Œæ¨é€é•œåƒæ—¶çš„å¸¦å®½æ¶ˆè€—è¶Šé«˜ã€‚</li></ul><p>ä½¿ç”¨ç®€å•æ˜äº†çš„Dockerfile</p><p>åŸºç¡€é•œåƒ Matter âœŒğŸ½ : é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ</p><p>åœ¨è€ƒè™‘ä¼˜åŒ–ä¹‹å‰ï¼Œä½ åº”è¯¥å§‹ç»ˆæ³¨æ„ç”¨äºæ‰“åŒ…åº”ç”¨çš„åŸºç¡€é•œåƒã€‚ä½ é€‰æ‹©çš„åŸºç¡€é•œåƒå¯èƒ½å¯¹æœ€ç»ˆé•œåƒçš„å¤§å°äº§ç”Ÿæ˜¾è‘—å½±å“ã€‚</p><p>å¯ä»¥ç”¨æ¥æ‰“åŒ…Javaåº”ç”¨çš„åŸºç¡€é•œåƒæœ‰å‡ ç§ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>JDK AlpineåŸºç¡€é•œåƒï¼šè¿™äº›é•œåƒä½“ç§¯è¾ƒå°ï¼Œä½†ä¸é€‚åˆæ‰€æœ‰åº”ç”¨ï¼Œå› æ­¤å¯èƒ½ä¼šé¢ä¸´ä¸€äº›åº“çš„å…¼å®¹æ€§é—®é¢˜ã€‚</li><li>JDK SlimåŸºç¡€é•œåƒï¼šè¿™äº›é•œåƒåŸºäºDebianæˆ–Ubuntuï¼Œç›¸è¾ƒäºå®Œæ•´çš„JDKé•œåƒæ¥è¯´ä½“ç§¯è¾ƒå°ï¼Œä½†ä»ç„¶æ¯”è¾ƒå¤§ã€‚</li><li>JDKå®Œæ•´åŸºç¡€é•œåƒï¼šè¿™äº›é•œåƒä½“ç§¯è¾ƒå¤§ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰æ¨¡å—å’Œä¾èµ–é¡¹ã€‚</li></ul><p>ä¸ºäº†ç»™ä½ ä¸€ä¸ªåŸºç¡€é•œåƒå¤§å°çš„æ¦‚å¿µï¼Œä»¥ä¸‹æ˜¯openjdk:17-jdk-slimï¼ˆç˜¦èº«ç‰ˆï¼‰å’Œeclipse-temurin:17-jdk-alpineé•œåƒå¤§å°çš„æ¯”è¾ƒï¼š</p><p>å·²çŸ¥åº”ç”¨ç¨‹åºï¼ˆjarï¼‰çš„å¤§å°çº¦ä¸º20MBã€‚</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1728611720648-5.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>ä¸ºäº†åœ¨Dockeré•œåƒä¸­æ‰“åŒ…æˆ‘ä»¬çš„å·¥ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åº”ç”¨æ ¹ç›®å½•ä¸­å®šä¹‰ä¸€ä¸ªDockerfileï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>FROM openjdk:17-jdk-slim</span></span>
<span class="line"><span></span></span>
<span class="line"><span># è®¾ç½®å®¹å™¨ä¸­çš„å·¥ä½œç›®å½•</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºç”¨æˆ·</span></span>
<span class="line"><span>RUN addgroup --system spring &amp;&amp; adduser --system spring --ingroup spring</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ‡æ¢åˆ°ç”¨æˆ·</span></span>
<span class="line"><span>USER spring:spring</span></span>
<span class="line"><span></span></span>
<span class="line"><span>COPY target/*.jar app.jar</span></span>
<span class="line"><span></span></span>
<span class="line"><span>EXPOSE 8080</span></span>
<span class="line"><span></span></span>
<span class="line"><span>CMD [&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®šä¹‰å¥½Dockerfileåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker build -t user-service .</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å®Œæˆåï¼Œä½ åº”è¯¥ä¼šæœ‰ä¸€ä¸ªåä¸ºuser-serviceçš„Dockeré•œåƒï¼Œæ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä¸åº”ç”¨ç¨‹åºå·¥ä»¶çš„å¤§å°ç›¸æ¯”ï¼Œé•œåƒçš„å¤§å°ç›¸å½“å¤§ï¼Œçº¦ä¸º674MBã€‚</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841996-1.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>ç­‰ç­‰ï¼Œè¿™åªæ˜¯ä¸€ä¸ªåªæœ‰ä¸¤ä¸ªç«¯ç‚¹çš„å°é¡¹ç›®ï¼Œæ²¡æœ‰ä»»ä½•ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªæœ‰æ•°åä¸ªä¾èµ–é¡¹å’Œæ–‡ä»¶çš„åº”ç”¨æ¥è¯´ï¼Œæƒ…å†µä¼šå¦‚ä½•å‘¢ï¼Ÿ</p><p>ä½¿ç”¨ <code>eclipse-temurin:17-jdk-alpine</code> ä½œä¸ºåŸºç¡€é•œåƒã€‚</p><p>Dockerfile.base-temurin</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>FROM eclipse-temurin:17-jdk-alpine</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ARG APPLICATION_USER=spring</span></span>
<span class="line"><span># åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ¥è¿è¡Œåº”ç”¨ï¼Œä¸ä»¥rootç”¨æˆ·è¿è¡Œ</span></span>
<span class="line"><span>RUN addgroup --system $APPLICATION_USER &amp;&amp; adduser --system $APPLICATION_USER --ingroup $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºåº”ç”¨ç›®å½•</span></span>
<span class="line"><span>RUN mkdir /app &amp;&amp; chown -R $APPLICATION_USER /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span># è®¾ç½®è¿è¡Œåº”ç”¨çš„ç”¨æˆ·</span></span>
<span class="line"><span>USER $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å°†jaræ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨ä¸­</span></span>
<span class="line"><span>COPY --chown=$APPLICATION_USER:$APPLICATION_USER target/*.jar /app/app.jar</span></span>
<span class="line"><span></span></span>
<span class="line"><span># è®¾ç½®å·¥ä½œç›®å½•</span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æš´éœ²ç«¯å£</span></span>
<span class="line"><span>EXPOSE 8080</span></span>
<span class="line"><span></span></span>
<span class="line"><span># è¿è¡Œåº”ç”¨</span></span>
<span class="line"><span>ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/app/app.jar&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒåï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker build -t user-service:alpine -f Dockerfile.base-alpine . --platform=linux/amd64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ğŸš¨ é™„æ³¨</p><p>é‡è¦æç¤ºï¼šå¦‚æœä½ åœ¨Apple Siliconçš„MACä¸Šæ„å»ºé•œåƒï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>&gt; [internal] load metadata for docker.io/library/eclipse-temurin:17-jdk-alpine:</span></span>
<span class="line"><span>Dockerfile:2</span></span>
<span class="line"><span>1 | # First stage, build the custom JRE</span></span>
<span class="line"><span>2 | &gt;&gt;&gt; FROM eclipse-temurin:17-jdk-alpine AS jre-builder</span></span>
<span class="line"><span>3 |</span></span>
<span class="line"><span>4 | # Install binutils, required by jlink</span></span>
<span class="line"><span>ERROR: failed to solve: eclipse-temurin:17-jdk-alpine: no match for platform in manifest: not found</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¦è§£å†³æ­¤é—®é¢˜ï¼Œä½ å¯ä»¥åœ¨Dockeræ„å»ºå‘½ä»¤ä¸­æ·»åŠ ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>--platform=linux/amd64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æˆ–è€…é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†é»˜è®¤å¹³å°è®¾ç½®ä¸º <code>linux/amd64</code>ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>export DOCKER_DEFAULT_PLATFORM=linux/amd64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä½¿ç”¨ <code>eclipse-temurin:17-jdk-alpine</code> ä½œä¸ºåŸºç¡€é•œåƒæ„å»ºå®Œé•œåƒåï¼Œæˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸ªç»“æœï¼š</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841996-2.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>çœ‹çœ‹ä¸¤ä¸ªé•œåƒçš„å¤§å°ï¼Œä½¿ç”¨ <code>eclipse-temurin:17-jdk-alpine</code> ä½œä¸ºåŸºç¡€é•œåƒçš„é•œåƒå¤§å°ä¸º180MBï¼Œæ¯”ä½¿ç”¨ <code>openjdk:17-jdk-slim</code> ä½œä¸ºåŸºç¡€é•œåƒçš„674MBå°73%ã€‚</p><p>å®é™…ä¼˜åŒ–</p><p>ç­‰ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨JREé•œåƒè€Œä½¿ç”¨JDKé•œåƒå‘¢ï¼Ÿ</p><p>å¥½é—®é¢˜ï¼è¿™æ˜¯å› ä¸ºä»Java 11å¼€å§‹ï¼ŒJREä¸å†å¯ç”¨ã€‚</p><p>æœ€é‡è¦çš„æ³¨æ„äº‹é¡¹æ˜¯â€œç”¨æˆ·å¯ä»¥ä½¿ç”¨jlinkåˆ›å»ºæ›´å°çš„è‡ªå®šä¹‰è¿è¡Œæ—¶â€ã€‚</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841996-3.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>ä½¿ç”¨ jlink æ„å»ºè‡ªå®šä¹‰ JRE é•œåƒ</p><p><code>jlink</code> æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ç”¨äºåˆ›å»ºä»…åŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€æ¨¡å—çš„è‡ªå®šä¹‰è¿è¡Œæ—¶é•œåƒã€‚</p><p>ğŸ‘‰ å¦‚æœä½ çš„åº”ç”¨ä¸ä¸æ•°æ®åº“äº¤äº’ï¼Œåˆ™æ— éœ€åœ¨é•œåƒä¸­åŒ…å« <code>java.sql</code> æ¨¡å—ã€‚å¦‚æœä½ ä¸ä¸æ¡Œé¢GUIäº¤äº’ï¼Œåˆ™æ— éœ€åœ¨é•œåƒä¸­åŒ…å« <code>java.desktop</code> æ¨¡å—ï¼Œç­‰ç­‰ã€‚</p><p>è¿™æœ‰ç‚¹åƒJREé•œåƒçš„æ›¿ä»£å“ï¼Œä½†å¯ä»¥æ›´å¥½åœ°æ§åˆ¶ä½ æƒ³è¦åœ¨é•œåƒä¸­ä½¿ç”¨çš„æ¨¡å—ã€‚</p><p>å› æ­¤ï¼Œä½¿ç”¨ <code>jlink</code>ï¼Œæˆ‘ä»¬çš„Dockerfileåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># ç¬¬ä¸€é˜¶æ®µï¼Œæ„å»ºè‡ªå®šä¹‰JRE</span></span>
<span class="line"><span>FROM eclipse-temurin:17-jdk-alpine AS jre-builder</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å®‰è£…binutilsï¼Œjlinkæ‰€éœ€</span></span>
<span class="line"><span>RUN apk update &amp;&amp; apk add binutils</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ„å»ºå°å‹JREé•œåƒ</span></span>
<span class="line"><span>RUN $JAVA_HOME/bin/jlink \\</span></span>
<span class="line"><span>         --verbose \\</span></span>
<span class="line"><span>         --add-modules ALL-MODULE-PATH \\</span></span>
<span class="line"><span>         --strip-debug \\</span></span>
<span class="line"><span>         --no-man-pages \\</span></span>
<span class="line"><span>         --no-header-files \\</span></span>
<span class="line"><span>         --compress=2 \\</span></span>
<span class="line"><span>         --output /optimized-jdk-17</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ç¬¬äºŒé˜¶æ®µï¼Œä½¿ç”¨è‡ªå®šä¹‰JREå¹¶æ„å»ºåº”ç”¨é•œåƒ</span></span>
<span class="line"><span>FROM alpine:latest</span></span>
<span class="line"><span>ENV JAVA_HOME=/opt/jdk/jdk-17</span></span>
<span class="line"><span>ENV PATH=&quot;\${JAVA_HOME}/bin:\${PATH}&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ä»åŸºç¡€é•œåƒä¸­å¤åˆ¶JRE</span></span>
<span class="line"><span>COPY --from=jre-builder /optimized-jdk-17 $JAVA_HOME</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ·»åŠ åº”ç”¨ç”¨æˆ·</span></span>
<span class="line"><span>ARG APPLICATION_USER=spring</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ¥è¿è¡Œåº”ç”¨ï¼Œä¸ä»¥rootç”¨æˆ·è¿è¡Œ</span></span>
<span class="line"><span>RUN addgroup --system $APPLICATION_USER &amp;&amp; adduser --system $APPLICATION_USER --ingroup $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºåº”ç”¨ç›®å½•</span></span>
<span class="line"><span>RUN mkdir /app &amp;&amp; chown -R $APPLICATION_USER /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>COPY --chown=$APPLICATION_USER:$APPLICATION_USER target/*.jar /app/app.jar</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>USER $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span>EXPOSE 8080</span></span>
<span class="line"><span>ENTRYPOINT [ &quot;java&quot;, &quot;-jar&quot;, &quot;/app/app.jar&quot; ]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„äº‹æƒ…ï¼š</p><p>æˆ‘ä»¬æœ‰ä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µç”¨äºä½¿ç”¨ <code>jlink</code> æ„å»ºè‡ªå®šä¹‰JREé•œåƒï¼Œç¬¬äºŒé˜¶æ®µç”¨äºå°†åº”ç”¨æ‰“åŒ…åœ¨ä¸€ä¸ªç²¾ç®€çš„Alpineé•œåƒä¸­ã€‚</p><p>åœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>eclipse-temurin:17-jdk-alpine</code> é•œåƒæ¥ä½¿ç”¨ <code>jlink</code> æ„å»ºè‡ªå®šä¹‰JREé•œåƒã€‚ç„¶åï¼Œæˆ‘ä»¬å®‰è£… <code>binutils</code>ï¼Œè¿™æ˜¯ <code>jlink</code> æ‰€éœ€çš„ï¼Œç„¶åè¿è¡Œ <code>jlink</code> æ¥æ„å»ºä¸€ä¸ªå°å‹JREé•œåƒï¼Œä½¿ç”¨ <code>--add-modules ALL-MODULE-PATH</code>ï¼ˆç›®å‰ï¼‰åŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰æ¨¡å—ã€‚</p><p>åœ¨ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨Alpineé•œåƒï¼ˆå…¶å¤§å°çº¦ä¸º3MBï¼‰ä½œä¸ºåŸºç¡€é•œåƒæ¥æ‰“åŒ…æˆ‘ä»¬çš„åº”ç”¨ï¼Œç„¶åä»ç¬¬ä¸€é˜¶æ®µè·å–è‡ªå®šä¹‰JREå¹¶å°†å…¶ç”¨ä½œ <code>JAVA_HOME</code>ã€‚</p><p>Dockerfileçš„å…¶ä½™éƒ¨åˆ†ä¸ä¹‹å‰çš„ç›¸åŒï¼Œåªæ˜¯å¤åˆ¶å·¥ä»¶å¹¶ä½¿ç”¨è‡ªå®šä¹‰ç”¨æˆ·ï¼ˆè€Œä¸æ˜¯rootï¼‰è®¾ç½®å…¥å£ç‚¹ã€‚</p><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker build -t user-service:jlink-all-modules-temurin -f Dockerfile.jlink-all-modules.temurin .</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>å¦‚æœä½ è¿è¡Œå‘½ä»¤ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker images user-service</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä½ ä¼šçœ‹åˆ°æ–°Dockeré•œåƒçš„å¤§å°ç°åœ¨ä¸º85.3MBï¼Œæ¯”åŸºç¡€é•œåƒå°çº¦95MB ğŸ‰ğŸ¥³</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-4.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>ä¸ºäº†ç¡®ä¿é•œåƒæŒ‰é¢„æœŸå·¥ä½œï¼Œä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker run -p 8080:8080 user-service:jlink-all-modules-temurin</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ä½ åº”è¯¥ä¼šçœ‹åˆ°åº”ç”¨æŒ‰é¢„æœŸè¿è¡Œã€‚</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-5.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>è¿™è¿˜ä¸å¤Ÿ ğŸ¤ŒğŸ½ ä½œä¸ºä¼˜ç§€çš„å¼€å‘è€…ï¼Œæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›æ”¹è¿›æˆ‘ä»¬çš„å·¥ä½œï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è¿›ä¸€æ­¥å‡å°‘é•œåƒçš„å¤§å°ã€‚</p><p>ç›®å‰é•œåƒçš„å¤§å°ä¾ç„¶è¾ƒå¤§ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ jlink å‘½ä»¤ä¸­ä½¿ç”¨ <code>--add-modules ALL-MODULE-PATH</code> æ—¶ï¼Œæˆ‘ä»¬åŒ…å«äº†è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ‰€æœ‰æ¨¡å—ï¼Œä½†æˆ‘ä»¬å¹¶ä¸éœ€è¦æ‰€æœ‰æ¨¡å—ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä»…åŒ…å«è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ¨¡å—ï¼Œä»è€Œè·å¾—æ›´å°çš„é•œåƒå¤§å°ã€‚</p><p>å¦‚ä½•ç¡®å®šè¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ¨¡å—ï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ JDK é™„å¸¦çš„ jdeps å·¥å…·ã€‚jdeps æ˜¯ä¸€ä¸ªå¯ä»¥åˆ†æ jar æ–‡ä»¶ä¾èµ–å…³ç³»å¹¶ç”Ÿæˆæ‰€éœ€æ¨¡å—åˆ—è¡¨çš„å·¥å…·ã€‚</p><p>ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>jdeps --ignore-missing-deps -q \\</span></span>
<span class="line"><span>      --recursive \\</span></span>
<span class="line"><span>      --multi-release 17 \\</span></span>
<span class="line"><span>      --print-module-deps \\</span></span>
<span class="line"><span>      --class-path BOOT-INF/lib/* \\</span></span>
<span class="line"><span>      target/spring-error-handling-rfc-9457-0.0.1-SNAPSHOT.jar</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å°†æ‰“å°å‡ºè¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€çš„æ¨¡å—åˆ—è¡¨ï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ä¸ºï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>java.base,java.compiler,java.desktop,java.instrument,java.management,java.naming,java.net.http,java.prefs,java.rmi,java.scripting,java.security.jgss,java.sql,jdk.jfr,jdk.unsupported</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†è¿™äº›æ¨¡å—æ›¿ä»£ <code>ALL-MODULE-PATH</code>ï¼Œä¿®æ”¹ jlink å‘½ä»¤å¦‚ä¸‹ï¼š</p><p>Dockerfile.jlink-known-modules.temurin</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># ç¬¬ä¸€é˜¶æ®µï¼Œæ„å»ºè‡ªå®šä¹‰ JRE</span></span>
<span class="line"><span>FROM openjdk:17-jdk-slim AS jre-builder</span></span>
<span class="line"><span></span></span>
<span class="line"><span># å®‰è£… jlink æ‰€éœ€çš„ binutils</span></span>
<span class="line"><span>RUN apt-get update -y &amp;&amp;  \\</span></span>
<span class="line"><span>    apt-get install -y binutils</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ„å»ºå°å‹ JRE é•œåƒ</span></span>
<span class="line"><span>RUN $JAVA_HOME/bin/jlink \\</span></span>
<span class="line"><span>         --verbose \\</span></span>
<span class="line"><span>         --add-modules java.base,java.compiler,java.desktop,java.instrument,java.management,java.naming,java.net.http,java.prefs,java.rmi,java.scripting,java.security.jgss,java.sql,jdk.jfr,jdk.unsupported \\</span></span>
<span class="line"><span>         --strip-debug \\</span></span>
<span class="line"><span>         --no-man-pages \\</span></span>
<span class="line"><span>         --no-header-files \\</span></span>
<span class="line"><span>         --compress=2 \\</span></span>
<span class="line"><span>         --output /optimized-jdk-17</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ç¬¬äºŒé˜¶æ®µï¼Œä½¿ç”¨è‡ªå®šä¹‰ JRE å¹¶æ„å»ºåº”ç”¨é•œåƒ</span></span>
<span class="line"><span>FROM alpine:latest</span></span>
<span class="line"><span>ENV JAVA_HOME=/opt/jdk/jdk-17</span></span>
<span class="line"><span>ENV PATH=&quot;\${JAVA_HOME}/bin:\${PATH}&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ä»åŸºç¡€é•œåƒå¤åˆ¶ JRE</span></span>
<span class="line"><span>COPY --from=jre-builder /optimized-jdk-17 $JAVA_HOME</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ·»åŠ åº”ç”¨ç”¨æˆ·</span></span>
<span class="line"><span>ARG APPLICATION_USER=spring</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºç”¨æˆ·ä»¥è¿è¡Œåº”ç”¨ç¨‹åºï¼Œä¸ä»¥ root èº«ä»½è¿è¡Œ</span></span>
<span class="line"><span>RUN addgroup --system $APPLICATION_USER &amp;&amp;  adduser --system $APPLICATION_USER --ingroup $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºåº”ç”¨ç¨‹åºç›®å½•</span></span>
<span class="line"><span>RUN mkdir /app &amp;&amp; chown -R $APPLICATION_USER /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>COPY --chown=$APPLICATION_USER:$APPLICATION_USER target/*.jar /app/app.jar</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>USER $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span>EXPOSE 8080</span></span>
<span class="line"><span>ENTRYPOINT [ &quot;java&quot;, &quot;-jar&quot;, &quot;/app/app.jar&quot; ]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker build -t user-service:jlink-known-modules-temurin -f Dockerfile.jlink-known-modules.temurin .</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>è¿™é‡Œæ˜¯æ„å»ºåçš„é•œåƒå¤§å°ï¼š</p><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-6.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªè¾ƒå°çš„é•œåƒï¼Œå¤§å°ä¸º 57.8MBï¼Œè€Œä¸æ˜¯ 85.3MBã€‚</p><p>è¿™å¾ˆå¥½ï¼Œä½†æˆ‘ä»¬èƒ½å¦è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨è¿è¡Œ jdeps å‘½ä»¤ç„¶åå°†æ¨¡å—å¤åˆ¶åˆ° jlink å‘½ä»¤ä¸­ï¼Ÿ</p><p>åœ¨ Dockerfile ä¸­è‡ªåŠ¨åŒ–è¯¥è¿‡ç¨‹</p><p>Dockerfile.jlink-with-jdeps.temurin</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span># ç¬¬ä¸€é˜¶æ®µï¼Œæ„å»ºè‡ªå®šä¹‰ JRE</span></span>
<span class="line"><span>FROM eclipse-temurin:17-jdk-alpine AS jre-builder</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN mkdir /opt/app</span></span>
<span class="line"><span>COPY . /opt/app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WORKDIR /opt/app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ENV MAVEN_VERSION 3.5.4</span></span>
<span class="line"><span>ENV MAVEN_HOME /usr/lib/mvn</span></span>
<span class="line"><span>ENV PATH $MAVEN_HOME/bin:$PATH</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN apk update &amp;&amp; \\</span></span>
<span class="line"><span>    apk add --no-cache tar binutils</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN wget http://archive.apache.org/dist/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>  tar -zxvf apache-maven-$MAVEN_VERSION-bin.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>  rm apache-maven-$MAVEN_VERSION-bin.tar.gz &amp;&amp; \\</span></span>
<span class="line"><span>  mv apache-maven-$MAVEN_VERSION /usr/lib/mvn</span></span>
<span class="line"><span></span></span>
<span class="line"><span>RUN mvn package -DskipTests</span></span>
<span class="line"><span>RUN jar xvf target/spring-error-handling-rfc-9457-0.0.1-SNAPSHOT.jar</span></span>
<span class="line"><span>RUN jdeps --ignore-missing-deps -q  \\</span></span>
<span class="line"><span>    --recursive  \\</span></span>
<span class="line"><span>    --multi-release 17  \\</span></span>
<span class="line"><span>    --print-module-deps  \\</span></span>
<span class="line"><span>    --class-path &#39;BOOT-INF/lib/*&#39;  \\</span></span>
<span class="line"><span>    target/spring-error-handling-rfc-9457-0.0.1-SNAPSHOT.jar &gt; modules.txt</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ„å»ºå°å‹ JRE é•œåƒ</span></span>
<span class="line"><span>RUN $JAVA_HOME/bin/jlink \\</span></span>
<span class="line"><span>         --verbose \\</span></span>
<span class="line"><span>         --add-modules $(cat modules.txt) \\</span></span>
<span class="line"><span>         --strip-debug \\</span></span>
<span class="line"><span>         --no-man-pages \\</span></span>
<span class="line"><span>         --no-header-files \\</span></span>
<span class="line"><span>         --compress=2 \\</span></span>
<span class="line"><span>         --output /optimized-jdk-17</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ç¬¬äºŒé˜¶æ®µï¼Œä½¿ç”¨è‡ªå®šä¹‰ JRE å¹¶æ„å»ºåº”ç”¨é•œåƒ</span></span>
<span class="line"><span>FROM alpine:latest</span></span>
<span class="line"><span>ENV JAVA_HOME=/opt/jdk/jdk-17</span></span>
<span class="line"><span>ENV PATH=&quot;\${JAVA_HOME}/bin:\${PATH}&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ä»åŸºç¡€é•œåƒå¤åˆ¶ JRE</span></span>
<span class="line"><span>COPY --from=jre-builder /optimized-jdk-17 $JAVA_HOME</span></span>
<span class="line"><span></span></span>
<span class="line"><span># æ·»åŠ åº”ç”¨ç”¨æˆ·</span></span>
<span class="line"><span>ARG APPLICATION_USER=spring</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºç”¨æˆ·ä»¥è¿è¡Œåº”ç”¨ç¨‹åºï¼Œä¸ä»¥ root èº«ä»½è¿è¡Œ</span></span>
<span class="line"><span>RUN addgroup --system $APPLICATION_USER &amp;&amp;  adduser --system $APPLICATION_USER --ingroup $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span># åˆ›å»ºåº”ç”¨ç¨‹åºç›®å½•</span></span>
<span class="line"><span>RUN mkdir /app &amp;&amp; chown -R $APPLICATION_USER /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>COPY --chown=$APPLICATION_USER:$APPLICATION_USER target/*.jar /app/app.jar</span></span>
<span class="line"><span></span></span>
<span class="line"><span>WORKDIR /app</span></span>
<span class="line"><span></span></span>
<span class="line"><span>USER $APPLICATION_USER</span></span>
<span class="line"><span></span></span>
<span class="line"><span>EXPOSE 8080</span></span>
<span class="line"><span>ENTRYPOINT [ &quot;java&quot;, &quot;-jar&quot;, &quot;/app/app.jar&quot; ]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ„å»ºé•œåƒï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>docker build -t user-service:jlink-with-jdeps.temurin -f Dockerfile.jlink-with-jdeps.temurin . --platform=linux/amd64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><figure><img src="https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-7.webp" alt="å›¾ç‰‡" tabindex="0" loading="lazy"><figcaption>å›¾ç‰‡</figcaption></figure><p>é¢å¤–æç¤º åœ¨ç»“æŸä¹‹å‰ï¼Œè¯·æ³¨æ„ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ <code>.dockerignore</code> æ–‡ä»¶æ’é™¤æŸäº›æ–‡ä»¶å’Œç›®å½•ï¼Œä»¥å‡å°‘é•œåƒåœ¨ä¸­é—´é˜¶æ®µçš„å¤§å°ã€‚</p><p>æ‚¨è¿˜åº”è¯¥æ³¨æ„ï¼Œé€‰æ‹©å°å‹åŸºç¡€é•œåƒæ˜¯å¥½çš„ï¼Œä½†è¯·ç¡®ä¿å®ƒå…·å¤‡è‰¯å¥½çš„å®‰å…¨ç­–ç•¥ï¼Œå¹¶ä¸æ‚¨çš„åº”ç”¨ç¨‹åºå…¼å®¹ã€‚</p><p>ç»“è®º</p><p>é€šè¿‡æœ¬æ–‡çš„æ¢è®¨ï¼Œæˆ‘ä»¬æˆåŠŸå±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ jlink å·¥å…·å’Œ jdeps å·¥å…·æ¥ç”Ÿæˆæ›´åŠ ç²¾ç®€çš„ Java é•œåƒã€‚æˆ‘ä»¬ä¸ä»…å‡å°‘äº†é•œåƒçš„ä½“ç§¯ï¼Œä» 85.3MB é™è‡³ 57.8MBï¼ŒèŠ‚çœäº†å¤§é‡çš„å­˜å‚¨å’Œä¼ è¾“èµ„æºï¼Œè€Œä¸”è¿˜å¼•å…¥äº†è‡ªåŠ¨åŒ–çš„è¿‡ç¨‹ï¼Œè¿›ä¸€æ­¥æå‡äº†å¼€å‘æ•ˆç‡ã€‚</p><p>åœ¨æŒç»­è¿½æ±‚ä¼˜åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œè‡ªåŠ¨åŒ–å·¥å…·å’Œæœ€ä½³å®è·µæ˜¯æ¯ä¸ªå¼€å‘è€…çš„å¾—åŠ›åŠ©æ‰‹ã€‚é€šè¿‡ä½¿ç”¨ .dockerignore æ–‡ä»¶æ¥æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶å’Œç›®å½•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ„å»ºé•œåƒçš„ä¸­é—´é˜¶æ®µè¿›ä¸€æ­¥å‡å°‘ä½“ç§¯ã€‚é€‰æ‹©ä¸€ä¸ªé€‚åˆçš„åŸºç¡€é•œåƒå¹¶ç¡®ä¿å…¶å®‰å…¨æ€§å’Œå…¼å®¹æ€§ï¼Œä¹ŸåŒæ ·é‡è¦ã€‚</p><p>æœ€åï¼Œä¼˜åŒ–é•œåƒä¸ä»…èƒ½æå‡åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæ›´èƒ½å¢å¼ºæ•´ä½“ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚å¸Œæœ›å¤§å®¶èƒ½å¤Ÿåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›æŠ€æœ¯ï¼Œè¿›ä¸€æ­¥æ¨åŠ¨è½¯ä»¶å¼€å‘çš„é«˜æ•ˆåŒ–å’Œç°ä»£åŒ–ã€‚</p>`,96)),n(e,{colorful:"",service:"email,qq,qzone,qrcode,weibo,telegram,twitter"})])}const g=p(v,[["render",u],["__file","Dockerç¼©å‡Javaé•œåƒå¤§å°.html.vue"]]),h=JSON.parse('{"path":"/dev/Docker%E7%BC%A9%E5%87%8FJava%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F.html","title":"Dockerç¼©å‡Javaé•œåƒå¤§å°","lang":"zh-CN","frontmatter":{"title":"Dockerç¼©å‡Javaé•œåƒå¤§å°","excerpt":null,"description":"Dockerç¼©å‡Javaé•œåƒå¤§å°","date":"2024-11-01T00:00:00.000Z","category":"Java","tag":"Java","author":"xlc520","article":true,"timeline":true,"icon":"java","head":[["meta",{"property":"og:url","content":"https://blog.ciberviler.top/dev/Docker%E7%BC%A9%E5%87%8FJava%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F.html"}],["meta",{"property":"og:site_name","content":"StudyNote - ä¸°å¯Œçš„çŸ¥è¯†ç¬”è®°åº“"}],["meta",{"property":"og:title","content":"Dockerç¼©å‡Javaé•œåƒå¤§å°"}],["meta",{"property":"og:description","content":"Dockerç¼©å‡Javaé•œåƒå¤§å°"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1728611720648-5.webp"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-15T14:46:53.000Z"}],["meta",{"property":"article:author","content":"xlc520"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:published_time","content":"2024-11-01T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-11-15T14:46:53.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Dockerç¼©å‡Javaé•œåƒå¤§å°\\",\\"image\\":[\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1728611720648-5.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841996-1.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841996-2.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841996-3.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-4.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-5.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-6.webp\\",\\"https://bitbucket.org/xlc520/blogasset/raw/main/images/2024/640-1730455841997-7.webp\\"],\\"datePublished\\":\\"2024-11-01T00:00:00.000Z\\",\\"dateModified\\":\\"2024-11-15T14:46:53.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xlc520\\"}]}"]]},"headers":[],"git":{"createdTime":1731681483000,"updatedTime":1731682013000,"contributors":[{"name":"xlc","email":"2215400217@qq.com","commits":2}]},"readingTime":{"minutes":11.53,"words":3458},"filePathRelative":"dev/Dockerç¼©å‡Javaé•œåƒå¤§å°.md","localizedDate":"2024å¹´11æœˆ1æ—¥","excerpt":""}');export{g as comp,h as data};
