import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,a as t}from"./app-DS3HItsn.js";const e={},p=t(`<h1 id="springboot-利用-threadpooltaskexecutor-批量插入" tabindex="-1"><a class="header-anchor" href="#springboot-利用-threadpooltaskexecutor-批量插入"><span>SpringBoot 利用 ThreadPoolTaskExecutor 批量插入</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span><strong>前言</strong></span></a></h2><p><strong>开发目的：</strong></p><p>提高百万级数据插入效率。</p><p><strong>采取方案：</strong></p><p>利用<code>ThreadPoolTaskExecutor</code>多线程批量插入。</p><p><strong>采用技术：</strong></p><ul><li>springboot2.1.1</li><li>mybatisPlus3.0.6</li><li>swagger2.5.0</li><li>Lombok1.18.4</li><li>postgresql</li><li>ThreadPoolTaskExecutor</li></ul><h2 id="具体实现细节" tabindex="-1"><a class="header-anchor" href="#具体实现细节"><span><strong>具体实现细节</strong></span></a></h2><p><code>application-dev.properties</code>添加线程池配置信息</p><div class="language-properties line-numbers-mode" data-ext="properties" data-title="properties"><pre class="language-properties"><code><span class="token comment"># 异步线程配置</span>
<span class="token comment"># 配置核心线程数</span>
<span class="token key attr-name">async.executor.thread.core_pool_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">30</span>
<span class="token comment"># 配置最大线程数</span>
<span class="token key attr-name">async.executor.thread.max_pool_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">30</span>
<span class="token comment"># 配置队列大小</span>
<span class="token key attr-name">async.executor.thread.queue_capacity</span> <span class="token punctuation">=</span> <span class="token value attr-value">99988</span>
<span class="token comment"># 配置线程池中的线程的名称前缀</span>
<span class="token key attr-name">async.executor.thread.name.prefix</span> <span class="token punctuation">=</span> <span class="token value attr-value">async-importDB-</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>spring 容器注入线程池 bean 对象</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutorConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${async.executor.thread.core_pool_size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${async.executor.thread.max_pool_size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxPoolSize<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${async.executor.thread.queue_capacity}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> queueCapacity<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${async.executor.thread.name.prefix}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> namePrefix<span class="token punctuation">;</span>
 
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;asyncServiceExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">asyncServiceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;start asyncServiceExecutor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在这里修改</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VisiableThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置核心线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置最大线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span>maxPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置队列大小</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span>queueCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置线程池中的线程的名称前缀</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span>namePrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// rejection-policy：当pool已经达到max size的时候，如何处理新任务</span>
        <span class="token comment">// CALLER_RUNS：不在新线程中执行任务，而是有调用者所在的线程来执行</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行初始化</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建异步线程 业务类</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AsyncService</span> <span class="token punctuation">{</span>
<span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Async</span><span class="token punctuation">(</span><span class="token string">&quot;asyncServiceExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeAsync</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogOutputResult</span><span class="token punctuation">&gt;</span></span> logOutputResults<span class="token punctuation">,</span> <span class="token class-name">LogOutputResultMapper</span> logOutputResultMapper<span class="token punctuation">,</span> <span class="token class-name">CountDownLatch</span> countDownLatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;start executeAsync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//异步线程要做的事情</span>
            logOutputResultMapper<span class="token punctuation">.</span><span class="token function">addLogOutputResultBatch</span><span class="token punctuation">(</span>logOutputResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;end executeAsync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 很关键, 无论上面程序是否异常必须执行countDown,否则await无法释放</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建多线程批量插入具体业务方法</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">testMultiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogOutputResult</span><span class="token punctuation">&gt;</span></span> logOutputResults <span class="token operator">=</span> <span class="token function">getTestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//测试每100条数据插入开一个线程</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">LogOutputResult</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> lists <span class="token operator">=</span> <span class="token class-name">ConvertHandler</span><span class="token punctuation">.</span><span class="token function">splitList</span><span class="token punctuation">(</span>logOutputResults<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>lists<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogOutputResult</span><span class="token punctuation">&gt;</span></span> listSub<span class="token operator">:</span>lists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        asyncService<span class="token punctuation">.</span><span class="token function">executeAsync</span><span class="token punctuation">(</span>listSub<span class="token punctuation">,</span> logOutputResultMapper<span class="token punctuation">,</span>countDownLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//保证之前的所有的线程都执行完成，才会走下面的；</span>
        <span class="token comment">// 这样就可以在下面拿到所有线程执行完的集合结果</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;阻塞异常:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> logOutputResults<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,17),o=[p];function c(l,i){return s(),a("div",null,o)}const k=n(e,[["render",c],["__file","SpringBoot利用ThreadPoolTaskExecutor批量插入.html.vue"]]),d=JSON.parse('{"path":"/dev/SpringBoot%E5%88%A9%E7%94%A8ThreadPoolTaskExecutor%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5.html","title":"SpringBoot利用ThreadPoolTaskExecutor批量插入","lang":"zh-CN","frontmatter":{"author":"xlc520","title":"SpringBoot利用ThreadPoolTaskExecutor批量插入","excerpt":null,"description":"SpringBoot 利用 ThreadPoolTaskExecutor 批量插入 前言 开发目的： 提高百万级数据插入效率。 采取方案： 利用ThreadPoolTaskExecutor多线程批量插入。 采用技术： springboot2.1.1 mybatisPlus3.0.6 swagger2.5.0 Lombok1.18.4 postgresq...","date":"2022-11-07T00:00:00.000Z","category":"Java","tag":["Java","SpringBoot"],"article":true,"timeline":true,"icon":"java","head":[["meta",{"property":"og:url","content":"https://blog.ciberviler.top/dev/SpringBoot%E5%88%A9%E7%94%A8ThreadPoolTaskExecutor%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5.html"}],["meta",{"property":"og:site_name","content":"StudyNote - 丰富的知识笔记库"}],["meta",{"property":"og:title","content":"SpringBoot利用ThreadPoolTaskExecutor批量插入"}],["meta",{"property":"og:description","content":"SpringBoot 利用 ThreadPoolTaskExecutor 批量插入 前言 开发目的： 提高百万级数据插入效率。 采取方案： 利用ThreadPoolTaskExecutor多线程批量插入。 采用技术： springboot2.1.1 mybatisPlus3.0.6 swagger2.5.0 Lombok1.18.4 postgresq..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-04-27T13:32:36.000Z"}],["meta",{"property":"article:author","content":"xlc520"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:tag","content":"SpringBoot"}],["meta",{"property":"article:published_time","content":"2022-11-07T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-04-27T13:32:36.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"SpringBoot利用ThreadPoolTaskExecutor批量插入\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2022-11-07T00:00:00.000Z\\",\\"dateModified\\":\\"2024-04-27T13:32:36.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xlc520\\"}]}"]]},"headers":[{"level":2,"title":"前言","slug":"前言","link":"#前言","children":[]},{"level":2,"title":"具体实现细节","slug":"具体实现细节","link":"#具体实现细节","children":[]}],"git":{"createdTime":1667833416000,"updatedTime":1714224756000,"contributors":[{"name":"xlc520","email":"2215400217@qq.com","commits":2},{"name":"xlc","email":"2215400217@qq.com","commits":1}]},"readingTime":{"minutes":1.67,"words":501},"filePathRelative":"dev/SpringBoot利用ThreadPoolTaskExecutor批量插入.md","localizedDate":"2022年11月7日","autoDesc":true}');export{k as comp,d as data};
